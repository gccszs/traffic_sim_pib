# 配置管理

<cite>
**本文档中引用的文件**  
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)
- [logback-spring.xml](file://traffic-sim-server/src/main/resources/logback-spring.xml)
- [docker-compose.yml](file://infrastructure/docker-compose.yml)
- [docker-compose.core.yml](file://infrastructure/docker-compose.core.yml)
- [docker-compose.mongodb.yml](file://infrastructure/docker-compose.mongodb.yml)
- [init.sql](file://infrastructure/init.sql)
- [my.cnf](file://infrastructure/mysql/conf/my.cnf)
- [redis.conf](file://infrastructure/redis/redis.conf)
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java)
- [plugin-user\src\main\resources\application.yml](file://plugins/plugin-user/src/main/resources/application.yml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心配置文件分析](#核心配置文件分析)
4. [服务器与端口配置](#服务器与端口配置)
5. [数据库连接配置](#数据库连接配置)
6. [Redis配置](#redis配置)
7. [日志配置](#日志配置)
8. [插件特定属性配置](#插件特定属性配置)
9. [Docker Compose基础设施配置](#docker-compose基础设施配置)
10. [配置最佳实践](#配置最佳实践)
11. [结论](#结论)

## 简介
本配置管理文档系统性地解释了交通仿真系统中的所有配置项，涵盖主应用配置文件`application.yml`及其环境特定文件（开发、生产环境），详细说明了服务器端口、数据库连接（MySQL, MongoDB）、Redis配置、日志设置以及各插件的特定属性。文档还深入分析了通过Docker Compose管理基础设施的配置策略，包括服务定义、网络和卷的配置。最后提供了配置最佳实践，重点关注敏感信息的管理和不同环境的配置策略。

## 项目结构
该项目采用模块化设计，主要分为前端、基础设施、地图转换服务、多个功能插件、通用组件和主服务器模块。基础设施目录包含完整的Docker配置，支持本地开发和生产环境部署。

```mermaid
graph TD
A[项目根目录] --> B[frontend]
A --> C[infrastructure]
A --> D[map_convert_services]
A --> E[plugins]
A --> F[traffic-sim-common]
A --> G[traffic-sim-server]
C --> H[docker-compose.yml]
C --> I[mysql/conf/my.cnf]
C --> J[redis/redis.conf]
C --> K[mongodb/init-mongo.js]
E --> L[plugin-auth]
E --> M[plugin-engine-manager]
E --> N[plugin-engine-replay]
E --> O[plugin-map]
E --> P[plugin-simulation]
E --> Q[plugin-statistics]
E --> R[plugin-user]
G --> S[application.yml]
G --> T[application-dev.yml]
G --> U[application-prod.yml]
G --> V[logback-spring.xml]
```

**Diagram sources**
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml)
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)

**Section sources**
- [infrastructure](file://infrastructure)
- [traffic-sim-server](file://traffic-sim-server)

## 核心配置文件分析
系统使用Spring Boot的配置文件体系，通过`application.yml`作为基础配置，`application-dev.yml`和`application-prod.yml`分别覆盖开发和生产环境的特定配置。这种分层配置机制允许在不同环境中灵活调整参数，同时保持核心配置的一致性。

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [traffic-sim-server/src/main/resources/application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

## 服务器与端口配置
服务器配置定义了应用的网络监听端口和上下文路径。在基础配置中，服务器端口设置为8080，上下文路径为`/api`，这意味着所有API端点都通过`http://localhost:8080/api`访问。

```mermaid
classDiagram
class ServerConfig {
+int port : 8080
+String contextPath : "/api"
+String encodingCharset : "UTF-8"
+boolean encodingEnabled : true
+boolean encodingForce : true
}
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L48-L57)

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L48-L57)

## 数据库连接配置
系统配置了MySQL和MongoDB两种数据库。MySQL作为主关系型数据库，用于存储用户、角色、权限等结构化数据；MongoDB作为文档数据库，用于存储地图等非结构化数据。

### MySQL配置
MySQL配置包括JDBC连接URL、用户名、密码以及Hikari连接池参数。连接URL中包含了时区、字符编码等重要参数，确保数据正确存储和读取。

```mermaid
classDiagram
class MySQLConfig {
+String driverClassName : "com.mysql.cj.jdbc.Driver"
+String url : "jdbc : mysql : //localhost : 3306/traffic_sim..."
+String username : "root"
+String password : "root"
+HikariConfig hikari
}
class HikariConfig {
+int minimumIdle : 5
+int maximumPoolSize : 20
+long connectionTimeout : 30000
+long idleTimeout : 600000
+long maxLifetime : 1800000
}
MySQLConfig --> HikariConfig : "包含"
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L6-L17)
- [infrastructure/mysql/conf/my.cnf](file://infrastructure/mysql/conf/my.cnf)

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L6-L17)
- [infrastructure/mysql/conf/my.cnf](file://infrastructure/mysql/conf/my.cnf)
- [infrastructure/init.sql](file://infrastructure/init.sql)

### MongoDB配置
MongoDB配置使用URI方式，包含了认证信息和数据库名称。这种配置方式更加简洁，将所有连接信息集中在一个字符串中。

```mermaid
classDiagram
class MongoDBConfig {
+String uri : "mongodb : //root : root@localhost : 27017/traffic_sim?authSource=admin"
+String host : "localhost"
+int port : 27017
+String database : "traffic_sim"
+String username : "root"
+String password : "root"
+String authenticationDatabase : "admin"
}
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L28-L40)

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L28-L40)
- [infrastructure/mongodb/init-mongo.js](file://infrastructure/mongodb/init-mongo.js)

## Redis配置
Redis配置主要在Docker Compose文件和Redis配置文件中定义。Redis作为缓存服务，配置了密码保护和AOF持久化机制，确保数据安全和可靠性。

```mermaid
classDiagram
class RedisConfig {
+String bind : "0.0.0.0"
+int port : 6379
+String requirepass : "redis123"
+boolean appendonly : "yes"
+String appendfsync : "everysec"
+String maxmemory : "512mb"
+String maxmemoryPolicy : "allkeys-lru"
+String loglevel : "notice"
+int databases : 16
}
```

**Diagram sources**
- [infrastructure/redis/redis.conf](file://infrastructure/redis/redis.conf)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L71-L89)

**Section sources**
- [infrastructure/redis/redis.conf](file://infrastructure/redis/redis.conf)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L71-L89)

## 日志配置
系统使用Logback作为日志框架，通过`logback-spring.xml`文件进行详细配置。配置了控制台输出、文件输出和错误日志单独输出三种appender，实现了日志的分级管理和存储。

```mermaid
classDiagram
class LogbackConfig {
+Appender CONSOLE
+Appender FILE
+Appender ERROR_FILE
+RootLogger root
+Logger com.traffic.sim
+Logger org.springframework
+Logger org.hibernate
}
class Appender {
<<interface>>
}
class ConsoleAppender {
+String pattern
+String charset
}
class RollingFileAppender {
+String file
+String fileNamePattern
+String maxFileSize
+int maxHistory
+String totalSizeCap
}
Appender <|-- ConsoleAppender
Appender <|-- RollingFileAppender
LogbackConfig --> ConsoleAppender : "引用"
LogbackConfig --> RollingFileAppender : "引用"
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/logback-spring.xml](file://traffic-sim-server/src/main/resources/logback-spring.xml)
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L104-L117)

**Section sources**
- [traffic-sim-server/src/main/resources/logback-spring.xml](file://traffic-sim-server/src/main/resources/logback-spring.xml)
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L104-L117)

## 插件特定属性配置
系统采用插件化架构，每个插件都有自己的配置属性。这些配置通过`@ConfigurationProperties`注解绑定到Java类，实现了类型安全的配置管理。

### 认证插件配置
认证插件（plugin-auth）的配置包含了JWT、密码和验证码三个方面的设置。JWT配置是安全性的核心，定义了密钥、访问令牌和刷新令牌的过期时间。

```mermaid
classDiagram
class AuthPluginProperties {
+Jwt jwt
+Password password
+Captcha captcha
}
class Jwt {
+String secret : "traffic-sim-jwt-secret-key-change-in-production"
+Long expire : 3600L
+Long refreshExpire : 86400L
}
class Password {
+Integer minLength : 6
+Boolean requireUppercase : false
+Boolean requireLowercase : true
+Boolean requireDigit : true
+Boolean requireSpecialChar : false
}
class Captcha {
+int length : 4
+int expireSeconds : 300
+boolean caseSensitive : false
}
AuthPluginProperties --> Jwt
AuthPluginProperties --> Password
AuthPluginProperties --> Captcha
```

**Diagram sources**
- [plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java)
- [plugins/plugin-auth/src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports](file://plugins/plugin-auth/src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports)

**Section sources**
- [plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java)

### 用户插件配置
用户插件（plugin-user）的配置相对简单，主要定义了默认角色和密码加密方式。

```mermaid
classDiagram
class UserPluginConfig {
+int defaultRole : 1
+String passwordEncryption : "BCrypt"
}
```

**Diagram sources**
- [plugins/plugin-user/src/main/resources/application.yml](file://plugins/plugin-user/src/main/resources/application.yml)

**Section sources**
- [plugins/plugin-user/src/main/resources/application.yml](file://plugins/plugin-user/src/main/resources/application.yml)

## Docker Compose基础设施配置
Docker Compose配置文件定义了整个系统的基础设施，包括MySQL、MongoDB、Redis、Kafka和Zookeeper等多个服务。通过`docker-compose.yml`文件，可以一键启动所有依赖服务。

### 主要服务定义
系统定义了多个核心服务，每个服务都有详细的配置，包括镜像、容器名称、环境变量、端口映射、数据卷和健康检查。

```mermaid
graph TD
A[Docker Compose] --> B[MySQL]
A --> C[MongoDB]
A --> D[Redis]
A --> E[Zookeeper]
A --> F[Kafka]
A --> G[Kafka UI]
B --> H[数据卷: mysql_data]
C --> I[数据卷: mongodb_data]
D --> J[数据卷: redis_data]
E --> K[数据卷: zookeeper_data]
F --> L[数据卷: kafka_data]
A --> M[网络: traffic-sim-network]
B --> M
C --> M
D --> M
E --> M
F --> M
G --> M
```

**Diagram sources**
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml)
- [infrastructure/docker-compose.core.yml](file://infrastructure/docker-compose.core.yml)

**Section sources**
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml)
- [infrastructure/docker-compose.core.yml](file://infrastructure/docker-compose.core.yml)
- [infrastructure/docker-compose.mongodb.yml](file://infrastructure/docker-compose.mongodb.yml)

### 网络与数据卷
系统定义了一个名为`traffic-sim-network`的自定义桥接网络，所有服务都连接到这个网络，实现了服务间的通信隔离和安全。同时，为每个持久化服务定义了独立的数据卷，确保数据的持久化存储。

```mermaid
flowchart TD
subgraph Network [traffic-sim-network]
A[MySQL]
B[MongoDB]
C[Redis]
D[Zookeeper]
E[Kafka]
F[Kafka UI]
end
A --> V1[(mysql_data)]
B --> V2[(mongodb_data)]
C --> V3[(redis_data)]
D --> V4[(zookeeper_data)]
E --> V5[(kafka_data)]
```

**Diagram sources**
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L229-L252)

**Section sources**
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L229-L252)

## 配置最佳实践
基于对系统配置的深入分析，以下是配置管理的最佳实践建议。

### 环境特定配置策略
系统采用了Spring Profile机制，通过`application-{profile}.yml`文件实现环境特定配置。开发环境使用`application-dev.yml`，生产环境使用`application-prod.yml`，基础配置在`application.yml`中定义。

```mermaid
flowchart TD
A[application.yml] --> |基础配置| B[所有环境]
C[application-dev.yml] --> |开发环境覆盖| D[开发环境]
E[application-prod.yml] --> |生产环境覆盖| F[生产环境]
style D fill:#9f9,stroke:#333
style F fill:#f9f,stroke:#333
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [traffic-sim-server/src/main/resources/application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [traffic-sim-server/src/main/resources/application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

### 敏感信息管理
生产环境配置文件`application-prod.yml`使用了Spring的占位符`${}`语法，从环境变量中读取敏感信息，如数据库密码、MongoDB认证信息等。这是一种安全的最佳实践，避免了敏感信息硬编码在配置文件中。

```mermaid
sequenceDiagram
participant App as 应用程序
participant Env as 环境变量
participant Config as 配置文件
Config->>App : 加载 application-prod.yml
App->>Env : 查询 DB_PASSWORD
Env-->>App : 返回密码值
App->>Config : 替换 ${DB_PASSWORD : root} 占位符
App->>App : 使用实际密码连接数据库
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml#L4-L6)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml#L14-L18)

**Section sources**
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml#L4-L6)

### 配置继承与覆盖
Spring Boot的配置文件具有明确的优先级顺序：命令行参数 > JVM系统属性 > 环境变量 > 配置文件。在同一配置文件中，后定义的属性会覆盖先定义的属性。在多配置文件情况下，profile-specific文件会覆盖基础配置文件中的同名属性。

```mermaid
graph TD
A[最高优先级] --> B[命令行参数]
B --> C[JVM系统属性]
C --> D[环境变量]
D --> E[application-prod.yml]
E --> F[application-dev.yml]
F --> G[application.yml]
G --> H[最低优先级]
```

**Diagram sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [traffic-sim-server/src/main/resources/application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [traffic-sim-server/src/main/resources/application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [traffic-sim-server/src/main/resources/application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

## 结论
本配置管理文档全面分析了交通仿真系统的配置体系，涵盖了从应用配置到基础设施配置的各个方面。系统采用了现代化的配置管理实践，包括分层配置、环境特定配置、敏感信息保护等。通过Docker Compose实现了基础设施即代码，确保了开发、测试和生产环境的一致性。插件化架构的配置设计体现了良好的模块化和可扩展性。建议在生产部署时严格遵循敏感信息管理最佳实践，使用环境变量或密钥管理服务来管理密码等敏感数据，确保系统的安全性。