# 应用配置

<cite>
**本文档中引用的文件**  
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)
- [logback-spring.xml](file://traffic-sim-server/src/main/resources/logback-spring.xml)
- [TrafficSimApplication.java](file://traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java)
- [EngineManagerProperties.java](file://plugins/plugin-engine-manager/src/main/java/com/traffic/sim/plugin/engine/manager/config/EngineManagerProperties.java)
- [SimulationPluginProperties.java](file://plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/SimulationPluginProperties.java)
- [MapPluginProperties.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/config/MapPluginProperties.java)
- [WebConfig.java](file://traffic-sim-server/src/main/java/com/traffic/sim/config/WebConfig.java)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心配置文件分析](#核心配置文件分析)
4. [服务器配置](#服务器配置)
5. [数据源与数据库配置](#数据源与数据库配置)
6. [JPA/Hibernate 配置](#jpa/hibernate-配置)
7. [MongoDB 配置](#mongodb-配置)
8. [Redis 配置](#redis-配置)
9. [gRPC 客户端配置](#grpc-客户端配置)
10. [自定义应用配置](#自定义应用配置)
11. [WebSocket 配置](#websocket-配置)
12. [文件上传限制](#文件上传限制)
13. [日志配置](#日志配置)
14. [多环境配置管理](#多环境配置管理)
15. [配置最佳实践](#配置最佳实践)

## 简介
本文档系统性地解释了交通仿真系统中的所有关键配置项，涵盖主配置文件 `application.yml` 及其环境特定配置文件 `application-dev.yml` 和 `application-prod.yml`。文档详细说明了服务器、数据源、JPA、MongoDB、gRPC、WebSocket、文件上传和日志等配置项的作用与最佳实践，并对比了不同环境下的配置差异。

## 项目结构
本项目采用基于 Spring Boot 的插件化架构，包含核心服务模块和多个功能插件。配置文件主要位于 `traffic-sim-server` 模块的 `src/main/resources` 目录下，包括主配置文件和针对不同环境的配置文件。

```mermaid
graph TB
subgraph "配置文件"
A[application.yml]
B[application-dev.yml]
C[application-prod.yml]
D[logback-spring.xml]
end
subgraph "核心模块"
E[traffic-sim-server]
F[traffic-sim-common]
end
subgraph "插件模块"
G[plugin-auth]
H[plugin-user]
I[plugin-map]
J[plugin-simulation]
K[plugin-engine-manager]
L[plugin-statistics]
M[plugin-engine-replay]
end
A --> E
B --> E
C --> E
D --> E
E --> F
E --> G
E --> H
E --> I
E --> J
E --> K
E --> L
E --> M
```

**Diagram sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [pom.xml](file://pom.xml)

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [pom.xml](file://pom.xml)

## 核心配置文件分析
系统使用 Spring Profile 机制实现多环境配置管理。主配置文件 `application.yml` 包含所有环境的公共配置，而 `application-dev.yml` 和 `application-prod.yml` 分别定义开发和生产环境的特定配置。

```mermaid
classDiagram
class ApplicationConfig {
+String appName
+ServerConfig server
+DataSourceConfig datasource
+JpaConfig jpa
+MongodbConfig data.mongodb
+GrpcConfig grpc.client
+AppConfig app
+LoggingConfig logging
}
class ServerConfig {
+int port
+String contextPath
}
class DataSourceConfig {
+String url
+String username
+String password
+HikariConfig hikari
}
class HikariConfig {
+int minimumIdle
+int maximumPoolSize
+long connectionTimeout
+long idleTimeout
+long maxLifetime
}
class JpaConfig {
+String hibernate.ddlAuto
+boolean showSql
+HibernateProperties properties.hibernate
}
class MongodbConfig {
+String uri
+String host
+int port
+String database
}
class GrpcConfig {
+PythonServiceConfig pythonService
}
class PythonServiceConfig {
+String address
+String negotiationType
+boolean enableKeepAlive
+boolean keepAliveWithoutCalls
+String keepAliveTime
+String keepAliveTimeout
}
class AppConfig {
+EngineConfig engine
+WebsocketConfig websocket
+UploadConfig upload
}
class EngineConfig {
+String host
+int port
+long timeout
}
class WebsocketConfig {
+FrontendConfig frontend
+EngineConfig engine
}
class FrontendConfig {
+String path
}
class EngineConfig {
+String path
}
class UploadConfig {
+String maxFileSize
+String maxRequestSize
}
class LoggingConfig {
+LogLevel level
+LogPattern pattern
+LogFile file
}
ApplicationConfig --> ServerConfig
ApplicationConfig --> DataSourceConfig
ApplicationConfig --> JpaConfig
ApplicationConfig --> MongodbConfig
ApplicationConfig --> GrpcConfig
ApplicationConfig --> AppConfig
ApplicationConfig --> LoggingConfig
DataSourceConfig --> HikariConfig
JpaConfig --> HibernateProperties
GrpcConfig --> PythonServiceConfig
AppConfig --> EngineConfig
AppConfig --> WebsocketConfig
AppConfig --> UploadConfig
WebsocketConfig --> FrontendConfig
WebsocketConfig --> EngineConfig
LoggingConfig --> LogLevel
LoggingConfig --> LogPattern
LoggingConfig --> LogFile
```

**Diagram sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

## 服务器配置
服务器配置定义了应用的网络端口和上下文路径等基本网络属性。

```mermaid
flowchart TD
A[服务器配置] --> B["端口: 3822"]
A --> C["上下文路径: /"]
A --> D["编码: UTF-8"]
A --> E["强制编码: true"]
B --> F[应用监听3822端口]
C --> G[所有请求以根路径为基础]
D --> H[请求和响应使用UTF-8编码]
E --> I[强制设置响应编码]
```

**Diagram sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)

## 数据源与数据库配置
系统配置了 MySQL 数据源，使用 HikariCP 作为连接池实现。

### MySQL 数据源配置
| 配置项 | 开发环境值 | 生产环境值 | 说明 |
|--------|------------|------------|------|
| URL | jdbc:mysql://localhost:3306/traffic_sim_dev | jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:traffic_sim} | 数据库连接URL |
| 用户名 | root | ${DB_USERNAME:root} | 数据库用户名 |
| 密码 | root | ${DB_PASSWORD:root} | 数据库密码 |

### HikariCP 连接池配置
| 配置项 | 值 | 说明 |
|--------|----|------|
| minimum-idle | 5 | 最小空闲连接数 |
| maximum-pool-size | 20 | 最大连接池大小 |
| connection-timeout | 30000 | 连接超时时间（毫秒） |
| idle-timeout | 600000 | 空闲超时时间（毫秒） |
| max-lifetime | 1800000 | 连接最大生命周期（毫秒） |

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

## JPA/Hibernate 配置
JPA 和 Hibernate 配置定义了 ORM 框架的行为和 SQL 生成策略。

| 配置项 | 值 | 说明 |
|--------|----|------|
| hibernate.ddl-auto | update | DDL 自动生成策略 |
| show-sql | true | 是否显示生成的SQL语句 |
| hibernate.dialect | org.hibernate.dialect.MySQL8Dialect | 数据库方言 |
| hibernate.format_sql | true | 是否格式化SQL输出 |

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)

## MongoDB 配置
系统支持两种 MongoDB 配置方式：URI 方式和分离式配置。

### URI 配置方式
```yaml
spring:
  data:
    mongodb:
      uri: mongodb://root:root@localhost:27017/traffic_sim?authSource=admin
```

### 分离式配置
```yaml
spring:
  data:
    mongodb:
      host: localhost
      port: 27017
      database: traffic_sim
      username: root
      password: root
      authentication-database: admin
```

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)

## Redis 配置
项目结构中包含 Redis 配置文件，但主配置文件中未发现 Redis 相关配置。Redis 可能通过其他方式配置或在插件中配置。

**Section sources**
- [infrastructure/redis/redis.conf](file://infrastructure/redis/redis.conf)

## gRPC 客户端配置
gRPC 客户端配置用于与 Python 服务进行通信。

| 配置项 | 值 | 说明 |
|--------|----|------|
| grpc.client.python-service.address | static://localhost:50051 | gRPC 服务地址 |
| grpc.client.python-service.negotiationType | plaintext | 通信协议类型 |
| grpc.client.python-service.enableKeepAlive | true | 是否启用保活机制 |
| grpc.client.python-service.keepAliveWithoutCalls | true | 即使没有调用也保持连接 |
| grpc.client.python-service.keepAliveTime | 30s | 保活时间间隔 |
| grpc.client.python-service.keepAliveTimeout | 5s | 保活超时时间 |

```mermaid
sequenceDiagram
participant Server as "Java服务"
participant GrpcClient as "gRPC客户端"
participant PythonService as "Python服务"
Server->>GrpcClient : 发起gRPC调用
GrpcClient->>PythonService : 建立连接
loop 保活机制
GrpcClient->>PythonService : 发送保活信号(30s间隔)
PythonService-->>GrpcClient : 响应保活
end
GrpcClient->>Server : 返回调用结果
```

**Diagram sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [SimulationPluginProperties.java](file://plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/SimulationPluginProperties.java)

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [SimulationPluginProperties.java](file://plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/SimulationPluginProperties.java)

## 自定义应用配置
系统定义了多个自定义配置项，用于控制应用特定功能。

### 引擎服务配置
| 配置项 | 值 | 说明 |
|--------|----|------|
| app.engine.python-service.host | localhost | Python服务主机 |
| app.engine.python-service.port | 5000 | Python服务端口 |
| app.engine.python-service.timeout | 30000 | 调用超时时间（毫秒） |

### 文件上传配置
| 配置项 | 值 | 说明 |
|--------|----|------|
| app.upload.max-file-size | 100MB | 单个文件最大大小 |
| app.upload.max-request-size | 100MB | 请求最大大小 |

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [MapPluginProperties.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/config/MapPluginProperties.java)

## WebSocket 配置
WebSocket 配置定义了前端和引擎通信的路径。

| 配置项 | 值 | 说明 |
|--------|----|------|
| app.websocket.frontend.path | /ws/frontend | 前端WebSocket路径 |
| app.websocket.engine.path | /ws/exe | 引擎WebSocket路径 |

这些配置与插件中的 `EngineManagerProperties` 类中的配置相呼应，后者提供了更详细的 WebSocket 配置选项。

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [EngineManagerProperties.java](file://plugins/plugin-engine-manager/src/main/java/com/traffic/sim/plugin/engine/manager/config/EngineManagerProperties.java)

## 文件上传限制
系统配置了文件上传的大小限制，确保服务器资源不被过度占用。

```mermaid
flowchart TD
A[文件上传请求] --> B{文件大小检查}
B --> |小于100MB| C[接受上传]
B --> |大于100MB| D[拒绝上传]
C --> E[处理文件]
D --> F[返回错误响应]
```

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [MapPluginProperties.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/config/MapPluginProperties.java)

## 日志配置
系统使用 Logback 作为日志框架，配置了控制台和文件两种输出方式。

### application.yml 中的日志配置
| 配置项 | 值 | 说明 |
|--------|----|------|
| logging.level.root | INFO | 根日志级别 |
| logging.level.com.traffic.sim | DEBUG | 应用包日志级别 |
| logging.level.org.springframework.web | INFO | Spring Web日志级别 |
| logging.level.org.hibernate | INFO | Hibernate日志级别 |
| logging.file.name | logs/traffic-sim-server.log | 日志文件名 |
| logging.file.max-size | 10MB | 单个日志文件最大大小 |
| logging.file.max-history | 30 | 保留的日志文件数量 |

### logback-spring.xml 中的详细配置
- 控制台输出格式：`%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n`
- 文件滚动策略：基于时间和大小的滚动，每天生成新文件，每个文件最大10MB
- 错误日志单独输出到 `logs/traffic-sim-server-error.log`
- 保留30天的历史日志，总大小不超过1GB

```mermaid
graph TD
A[日志事件] --> B{日志级别}
B --> |ERROR| C[ERROR_FILE Appender]
B --> |其他| D{输出目标}
D --> E[CONSOLE Appender]
D --> F[FILE Appender]
C --> G[错误日志文件]
E --> H[控制台]
F --> I[普通日志文件]
```

**Diagram sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [logback-spring.xml](file://traffic-sim-server/src/main/resources/logback-spring.xml)

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [logback-spring.xml](file://traffic-sim-server/src/main/resources/logback-spring.xml)

## 多环境配置管理
系统使用 Spring Profile 实现多环境配置管理，通过 `application-{profile}.yml` 文件区分不同环境。

### 环境配置对比
| 配置项 | 公共配置 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|----------|------|
| 数据库URL | - | traffic_sim_dev | ${DB_NAME:traffic_sim} | 数据库名称不同 |
| 数据库连接 | - | useSSL=false | useSSL=true | 生产环境启用SSL |
| 日志级别 | - | DEBUG | INFO | 生产环境减少日志输出 |
| 日志文件路径 | logs/... | logs/... | /var/log/... | 生产环境使用标准日志路径 |
| 敏感信息 | 明文 | 明文 | 环境变量 | 生产环境使用环境变量 |

### 配置加载优先级
1. `application.yml`（基础配置）
2. `application-{profile}.yml`（环境特定配置，覆盖基础配置）
3. 环境变量（最高优先级，覆盖所有文件配置）

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-dev.yml](file://traffic-sim-server/src/main/resources/application-dev.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)

## 配置最佳实践
### 敏感信息保护
生产环境配置中使用环境变量替代明文密码，提高安全性：
```yaml
spring:
  datasource:
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:root}
```

### 配置项分类
- **公共配置**：放在 `application.yml` 中，所有环境共享
- **环境特定配置**：放在 `application-{env}.yml` 中，如数据库名称、日志级别
- **敏感配置**：通过环境变量注入，不写入配置文件

### 配置验证
系统在启动时会验证配置的有效性，特别是 gRPC 客户端配置。如果 gRPC 服务不可用，应用会记录警告但继续启动，使用兜底数据。

```mermaid
flowchart TD
A[应用启动] --> B[加载配置]
B --> C[初始化gRPC客户端]
C --> D{gRPC服务可用?}
D --> |是| E[正常启动]
D --> |否| F[记录警告]
F --> G[使用兜底数据]
G --> H[继续启动]
```

**Diagram sources**
- [TrafficSimApplication.java](file://traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java)

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [application-prod.yml](file://traffic-sim-server/src/main/resources/application-prod.yml)
- [TrafficSimApplication.java](file://traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java)