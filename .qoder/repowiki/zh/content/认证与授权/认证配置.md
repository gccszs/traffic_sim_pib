# 认证配置

<cite>
**本文档引用的文件**  
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java)
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java)
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java)
- [CaptchaService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/CaptchaService.java)
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java)
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java)
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [README.md](file://plugins/plugin-auth/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [核心配置项详解](#核心配置项详解)
3. [配置属性绑定机制](#配置属性绑定机制)
4. [YAML配置示例](#yaml配置示例)
5. [安全影响与用户体验分析](#安全影响与用户体验分析)
6. [最佳实践建议](#最佳实践建议)

## 简介
本指南详细说明了交通仿真系统中认证插件（`plugin-auth`）的全部可配置项。重点涵盖JWT令牌配置、密码策略设置和验证码参数，旨在为开发人员和系统管理员提供完整的配置参考，确保系统在安全性与可用性之间取得平衡。

## 核心配置项详解

### JWT配置
`AuthPluginProperties.Jwt` 类定义了与JWT（JSON Web Token）相关的所有配置项，这些令牌用于用户身份认证和会话管理。

- **密钥 (secret)**: 用于签名和验证JWT的密钥。默认值为 `"traffic-sim-jwt-secret-key-change-in-production"`。**在生产环境中必须更改此默认值**，否则系统将面临严重的安全风险，攻击者可能伪造任意用户的身份。
- **访问令牌过期时间 (expire)**: 定义访问令牌的有效期，单位为秒。默认值为 `3600` 秒（1小时）。较短的过期时间更安全，但会增加用户频繁重新登录的不便。
- **刷新令牌过期时间 (refreshExpire)**: 定义刷新令牌的有效期，单位为秒。默认值为 `86400` 秒（24小时）。刷新令牌用于在访问令牌过期后获取新的访问令牌，而无需用户重新输入密码。

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L31-L46)
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L27-L42)

### 密码策略配置
`AuthPluginProperties.Password` 类定义了用户注册和修改密码时必须遵守的强度策略。

- **最小长度 (minLength)**: 密码的最小字符数。默认值为 `6`。建议设置为8位或以上以增强安全性。
- **需要大写字母 (requireUppercase)**: 是否强制密码包含至少一个大写字母。默认值为 `false`。
- **需要小写字母 (requireLowercase)**: 是否强制密码包含至少一个小写字母。默认值为 `false`。
- **需要数字 (requireDigit)**: 是否强制密码包含至少一个数字。默认值为 `false`。
- **需要特殊字符 (requireSpecial)**: 是否强制密码包含至少一个特殊字符（如!@#$%^&*等）。默认值为 `false`。

这些策略在用户注册时由 `AuthServiceImpl` 的 `validatePasswordStrength` 方法进行校验。

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L49-L74)
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L233-L260)

### 验证码配置
`AuthPluginProperties.Captcha` 类定义了图形验证码的生成和验证规则。

- **启用状态 (enabled)**: 是否开启登录/注册时的验证码验证。默认值为 `true`。开启后可有效防止自动化脚本的暴力破解。
- **图片宽度 (width)**: 验证码图片的宽度，单位为像素。默认值为 `120`。
- **图片高度 (height)**: 验证码图片的高度，单位为像素。默认值为 `40`。
- **验证码长度 (length)**: 图片中显示的字符数量。默认值为 `4`。增加长度会提高安全性，但可能影响用户体验。
- **过期时间 (expireSeconds)**: 验证码的有效期，单位为秒。默认值为 `300` 秒（5分钟）。过期后验证码将失效，需要重新获取。

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L76-L102)
- [CaptchaService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/CaptchaService.java#L28-L55)

## 配置属性绑定机制
`AuthPluginProperties` 类通过Spring Boot的 `@ConfigurationProperties` 注解实现了类型安全的配置绑定。

- **注解作用**: `@ConfigurationProperties(prefix = "plugin.auth")` 告诉Spring Boot将配置文件中以 `plugin.auth` 为前缀的所有属性自动映射到该类的对应字段上。
- **自动配置**: `AuthPluginAutoConfiguration` 类使用 `@EnableConfigurationProperties(AuthPluginProperties.class)` 注解，确保 `AuthPluginProperties` 被注册为Spring容器中的Bean，从而使其配置生效。
- **工作流程**: 当Spring Boot应用启动时，它会读取 `application.yml` 文件，找到 `plugin.auth` 下的所有子属性，并根据属性名（如 `jwt.secret`）自动调用 `AuthPluginProperties` 类中相应字段的setter方法进行赋值。

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L12)
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java#L17)

## YAML配置示例
以下是在 `application.yml` 文件中配置认证插件的正确格式示例：

```yaml
plugin:
  auth:
    jwt:
      secret: "your-very-secure-and-long-secret-key-here" # 生产环境必须修改！
      expire: 3600
      refresh-expire: 86400
    password:
      min-length: 8
      require-uppercase: true
      require-lowercase: true
      require-digit: true
      require-special: true
    captcha:
      enabled: true
      width: 120
      height: 40
      length: 4
      expire-seconds: 300
```

**Section sources**
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [README.md](file://plugins/plugin-auth/README.md#L48-L67)

## 安全影响与用户体验分析

### 安全性影响
- **JWT密钥**: 使用默认密钥是最大的安全漏洞。一旦泄露，攻击者可以生成任意有效的令牌，完全绕过认证系统。
- **密码策略**: 更严格的密码策略（如要求大小写字母、数字和特殊字符）能显著增加密码被暴力破解的难度。
- **验证码**: 启用验证码是防御自动化攻击（如撞库、暴力破解）的第一道防线，能有效保护用户账户安全。

### 用户体验影响
- **令牌过期时间**: 访问令牌过期时间过短会导致用户频繁登录，影响体验；过长则增加令牌被盗用的风险。
- **密码策略**: 过于复杂的密码策略可能导致用户难以记住密码，从而倾向于使用不安全的记录方式或频繁重置密码。
- **验证码**: 验证码增加了登录步骤的复杂性，可能对部分用户造成困扰，但其带来的安全收益通常远大于体验损失。

**Section sources**
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java)
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java)
- [CaptchaService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/CaptchaService.java)

## 最佳实践建议
1. **强制更改JWT密钥**: 在部署到生产环境前，必须将 `plugin.auth.jwt.secret` 的值修改为一个长且随机的字符串。
2. **平衡密码策略**: 建议至少启用 `min-length: 8` 和 `require-digit: true`，根据安全需求逐步增加其他要求。
3. **监控验证码有效性**: 定期检查验证码的失败率，如果过高，可能需要调整验证码的复杂度或考虑引入更先进的验证方式（如滑块验证）。
4. **定期轮换密钥**: 对于高安全要求的系统，应建立JWT密钥的定期轮换机制。
5. **使用外部存储**: 如需集群部署，应将刷新令牌和失效令牌的存储从内存迁移到Redis等分布式缓存中。

**Section sources**
- [README.md](file://plugins/plugin-auth/README.md#L158-L162)