# 认证与授权

<cite>
**本文档引用的文件**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java)
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java)
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java)
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java)
- [RequireRole.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequireRole.java)
- [RequirePermission.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequirePermission.java)
- [RequestContext.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/util/RequestContext.java)
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java)
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java)
- [RegisterRequest.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/dto/RegisterRequest.java)
- [AuthService.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/service/AuthService.java)
- [CaptchaService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/CaptchaService.java)
- [plugin-auth-Issue.md](file://plugins/plugin-auth/plugin-auth-Issue.md)
</cite>

## 目录
1. [认证与授权概述](#认证与授权概述)
2. [核心组件分析](#核心组件分析)
3. [认证流程详解](#认证流程详解)
4. [JWT令牌机制](#jwt令牌机制)
5. [配置管理](#配置管理)
6. [拦截器工作原理](#拦截器工作原理)
7. [权限控制机制](#权限控制机制)
8. [API接口与使用示例](#api接口与使用示例)
9. [安全最佳实践与问题](#安全最佳实践与问题)
10. [总结](#总结)

## 认证与授权概述

本系统实现了基于JWT的完整认证与授权机制，包含用户登录、注册、令牌管理、权限验证等功能。认证系统采用插件化设计，通过`plugin-auth`模块提供服务，与其他业务模块解耦。系统使用JWT（JSON Web Token）作为认证令牌，结合刷新令牌机制实现安全的无状态认证。

认证流程包含验证码验证、用户凭证验证、JWT令牌生成等环节。授权机制基于角色和权限的双重控制，通过注解方式在方法级别进行细粒度权限控制。整个认证授权系统由多个核心组件协同工作，包括认证服务、令牌服务、拦截器、配置管理等。

**Section sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L1-L41)
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java#L1-L50)

## 核心组件分析

### AuthServiceImpl 实现分析

`AuthServiceImpl`是认证服务的核心实现类，实现了`AuthService`接口，提供了用户登录、注册、令牌验证、刷新和登出等主要功能。该类通过依赖注入获取`UserService`、`JwtTokenService`、`CaptchaService`和`AuthPluginProperties`等组件，实现了完整的认证业务逻辑。

```mermaid
classDiagram
class AuthServiceImpl {
-UserService userService
-JwtTokenService jwtTokenService
-CaptchaService captchaService
-AuthPluginProperties authProperties
-ConcurrentHashMap~String, TokenInfo~ refreshTokenStore
-ConcurrentHashMap~String, Long~ invalidatedTokens
+LoginResponse login(LoginRequest request)
+void register(RegisterRequest request)
+TokenInfo validateToken(String token)
+LoginResponse refreshToken(String refreshToken)
+void logout(String token)
-TokenInfo createTokenInfo(UserDTO user)
-void validatePasswordStrength(String password)
}
class AuthService {
<<interface>>
+LoginResponse login(LoginRequest request)
+void register(RegisterRequest request)
+TokenInfo validateToken(String token)
+LoginResponse refreshToken(String refreshToken)
+void logout(String token)
}
class JwtTokenService {
-AuthPluginProperties authProperties
+String generateAccessToken(TokenInfo tokenInfo)
+String generateRefreshToken(TokenInfo tokenInfo)
+TokenInfo parseToken(String token)
+boolean validateToken(String token)
}
class CaptchaService {
-AuthPluginProperties authProperties
+CaptchaResult generateCaptcha()
+boolean validateCaptcha(String captchaId, String captcha)
}
AuthServiceImpl --> AuthService : "实现"
AuthServiceImpl --> UserService : "依赖"
AuthServiceImpl --> JwtTokenService : "依赖"
AuthServiceImpl --> CaptchaService : "依赖"
AuthServiceImpl --> AuthPluginProperties : "依赖"
AuthServiceImpl --> TokenInfo : "使用"
AuthServiceImpl --> UserDTO : "使用"
```

**Diagram sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L29-L263)
- [AuthService.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/service/AuthService.java#L13-L40)

**Section sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L1-L263)

### JwtTokenService 令牌服务

`JwtTokenService`负责JWT令牌的生成、解析和验证。该服务使用`io.jsonwebtoken`库实现JWT标准，通过HMAC-SHA算法对令牌进行签名，确保令牌的完整性和安全性。服务支持生成访问令牌和刷新令牌两种类型的JWT，分别具有不同的过期时间。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthController as "AuthController"
participant AuthServiceImpl as "AuthServiceImpl"
participant JwtTokenService as "JwtTokenService"
Client->>AuthController : 登录请求
AuthController->>AuthServiceImpl : 调用login方法
AuthServiceImpl->>JwtTokenService : generateAccessToken(tokenInfo)
JwtTokenService-->>AuthServiceImpl : 返回accessToken
AuthServiceImpl->>JwtTokenService : generateRefreshToken(tokenInfo)
JwtTokenService-->>AuthServiceImpl : 返回refreshToken
AuthServiceImpl-->>AuthController : 返回登录响应
AuthController-->>Client : 返回包含令牌的响应
```

**Diagram sources**
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L25-L118)
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L75-L76)

**Section sources**
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L1-L118)

## 认证流程详解

### 用户登录流程

用户登录流程包含多个验证步骤，确保认证过程的安全性。首先验证验证码（如果启用），然后验证用户名和密码，最后生成JWT令牌。登录流程的实现细节如下：

```mermaid
flowchart TD
Start([开始]) --> ValidateCaptcha["验证验证码"]
ValidateCaptcha --> CaptchaValid{"验证码有效?"}
CaptchaValid --> |否| ReturnError1["返回验证码错误"]
CaptchaValid --> |是| ValidateCredentials["验证用户凭证"]
ValidateCredentials --> CredentialsValid{"凭证有效?"}
CredentialsValid --> |否| ReturnError2["返回凭证错误"]
CredentialsValid --> |是| CheckUserStatus["检查用户状态"]
CheckUserStatus --> UserActive{"用户激活?"}
UserActive --> |否| ReturnError3["返回用户禁用"]
UserActive --> |是| GenerateTokenInfo["生成TokenInfo"]
GenerateTokenInfo --> GenerateTokens["生成访问令牌和刷新令牌"]
GenerateTokens --> StoreRefreshToken["存储刷新令牌"]
StoreRefreshToken --> BuildResponse["构建登录响应"]
BuildResponse --> End([结束])
ReturnError1 --> End
ReturnError2 --> End
ReturnError3 --> End
```

**Diagram sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L47-L89)
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java#L41-L43)

**Section sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L47-L89)

### 用户注册流程

用户注册流程包含密码强度验证、用户名唯一性检查和用户创建等步骤。系统通过`AuthPluginProperties`中的密码配置来验证密码强度，确保用户账户的安全性。

```mermaid
flowchart TD
Start([开始]) --> ValidatePassword["验证密码强度"]
ValidatePassword --> PasswordStrong{"密码强度足够?"}
PasswordStrong --> |否| ReturnError1["返回密码强度不足"]
PasswordStrong --> |是| CheckUsername["检查用户名是否已存在"]
CheckUsername --> UsernameExists{"用户名已存在?"}
UsernameExists --> |是| ReturnError2["返回用户名已存在"]
UsernameExists --> |否| CreateUserDTO["创建UserDTO对象"]
CreateUserDTO --> SetDefaultRole["设置默认角色"]
SetDefaultRole --> CallUserService["调用UserService创建用户"]
CallUserService --> LogSuccess["记录注册成功日志"]
LogSuccess --> End([结束])
ReturnError1 --> End
ReturnError2 --> End
```

**Diagram sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L93-L123)
- [RegisterRequest.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/dto/RegisterRequest.java#L1-L31)

**Section sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L93-L123)

## JWT令牌机制

### 令牌生成与解析

JWT令牌服务使用HMAC-SHA256算法对令牌进行签名，确保令牌的完整性和防篡改性。访问令牌和刷新令牌的生成过程相似，但具有不同的过期时间。令牌中包含用户ID、用户名、角色、权限列表、签发时间和过期时间等声明。

```mermaid
classDiagram
class TokenInfo {
+String userId
+String username
+String role
+String[] permissions
+Long issuedAt
+Long expiresAt
+setUserId(String userId)
+getUserId() String
+setUsername(String username)
+getUsername() String
+setRole(String role)
+getRole() String
+setPermissions(String[] permissions)
+getPermissions() String[]
+setIssuedAt(Long issuedAt)
+getIssuedAt() Long
+setExpiresAt(Long expiresAt)
+getExpiresAt() Long
}
class JwtTokenService {
+String generateAccessToken(TokenInfo tokenInfo)
+String generateRefreshToken(TokenInfo tokenInfo)
+TokenInfo parseToken(String token)
+boolean validateToken(String token)
}
JwtTokenService --> TokenInfo : "使用"
```

**Diagram sources**
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L46-L63)
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L68-L89)

**Section sources**
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L25-L118)

### 令牌刷新与登出

令牌刷新机制允许用户在访问令牌过期后，使用刷新令牌获取新的访问令牌，而无需重新登录。登出机制通过将令牌添加到失效令牌存储中来实现，确保已登出的令牌无法再被使用。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthController as "AuthController"
participant AuthServiceImpl as "AuthServiceImpl"
Client->>AuthController : 刷新令牌请求
AuthController->>AuthServiceImpl : 调用refreshToken方法
AuthServiceImpl->>AuthServiceImpl : 验证刷新令牌
AuthServiceImpl->>JwtTokenService : 生成新的访问令牌
JwtTokenService-->>AuthServiceImpl : 返回新访问令牌
AuthServiceImpl->>JwtTokenService : 生成新的刷新令牌
JwtTokenService-->>AuthServiceImpl : 返回新刷新令牌
AuthServiceImpl->>AuthServiceImpl : 更新刷新令牌存储
AuthServiceImpl-->>AuthController : 返回刷新响应
AuthController-->>Client : 返回包含新令牌的响应
```

**Diagram sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L146-L182)
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java#L81-L84)

**Section sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L146-L182)

## 配置管理

### AuthPluginProperties 配置项

`AuthPluginProperties`类定义了认证插件的所有配置项，通过Spring Boot的`@ConfigurationProperties`机制进行配置注入。配置项分为JWT、密码和验证码三个部分，提供了灵活的配置选项。

```mermaid
classDiagram
class AuthPluginProperties {
+Jwt jwt
+Password password
+Captcha captcha
}
class Jwt {
+String secret
+Long expire
+Long refreshExpire
}
class Password {
+Integer minLength
+Boolean requireUppercase
+Boolean requireLowercase
+Boolean requireDigit
+Boolean requireSpecial
}
class Captcha {
+Boolean enabled
+Integer width
+Integer height
+Integer length
+Integer expireSeconds
}
AuthPluginProperties --> Jwt : "包含"
AuthPluginProperties --> Password : "包含"
AuthPluginProperties --> Captcha : "包含"
```

**Diagram sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L13-L105)

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L1-L105)

### 配置项详细说明

#### JWT配置
- **secret**: JWT签名密钥，默认值为"traffic-sim-jwt-secret-key-change-in-production"，**生产环境必须更换**
- **expire**: 访问令牌过期时间（秒），默认3600秒（1小时）
- **refreshExpire**: 刷新令牌过期时间（秒），默认86400秒（24小时）

#### 密码配置
- **minLength**: 密码最小长度，默认6位
- **requireUppercase**: 是否需要大写字母，默认false
- **requireLowercase**: 是否需要小写字母，默认false
- **requireDigit**: 是否需要数字，默认false
- **requireSpecial**: 是否需要特殊字符，默认false

#### 验证码配置
- **enabled**: 是否启用验证码，默认true
- **width**: 验证码图片宽度，默认120像素
- **height**: 验证码图片高度，默认40像素
- **length**: 验证码长度，默认4位
- **expireSeconds**: 验证码过期时间（秒），默认300秒（5分钟）

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L13-L105)

## 拦截器工作原理

### AuthenticationInterceptor 认证拦截器

认证拦截器负责在请求处理前验证JWT令牌的有效性。拦截器会检查请求路径是否在排除列表中，对于需要认证的路径，从Authorization头或请求参数中提取令牌并进行验证。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthenticationInterceptor as "认证拦截器"
participant AuthService as "AuthService"
Client->>AuthenticationInterceptor : 发送请求
AuthenticationInterceptor->>AuthenticationInterceptor : 检查路径是否排除
AuthenticationInterceptor-->>Client : 如果排除，放行请求
AuthenticationInterceptor->>AuthenticationInterceptor : 提取Authorization头
AuthenticationInterceptor->>AuthenticationInterceptor : 验证Bearer令牌格式
AuthenticationInterceptor->>AuthService : 调用validateToken方法
AuthService-->>AuthenticationInterceptor : 返回TokenInfo或null
AuthenticationInterceptor-->>Client : 如果无效，返回401错误
AuthenticationInterceptor->>RequestContext : 设置当前用户信息
AuthenticationInterceptor-->>Client : 放行请求
```

**Diagram sources**
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java#L46-L74)
- [RequestContext.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/util/RequestContext.java#L18-L20)

**Section sources**
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java#L29-L125)

### PermissionInterceptor 权限拦截器

权限拦截器在认证拦截器之后执行，负责验证用户的角色和权限。拦截器会检查方法或类上的`@RequireRole`和`@RequirePermission`注解，并验证当前用户是否具有相应的角色或权限。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant PermissionInterceptor as "权限拦截器"
participant RequestContext as "RequestContext"
Client->>PermissionInterceptor : 发送请求
PermissionInterceptor->>RequestContext : 获取当前用户信息
PermissionInterceptor-->>Client : 如果未认证，返回403错误
PermissionInterceptor->>PermissionInterceptor : 检查方法级@RequirePermission
PermissionInterceptor->>PermissionInterceptor : 验证用户权限
PermissionInterceptor-->>Client : 如果权限不足，返回403错误
PermissionInterceptor->>PermissionInterceptor : 检查方法级@RequireRole
PermissionInterceptor->>PermissionInterceptor : 验证用户角色
PermissionInterceptor-->>Client : 如果角色不足，返回403错误
PermissionInterceptor->>PermissionInterceptor : 检查类级@RequirePermission
PermissionInterceptor->>PermissionInterceptor : 验证用户权限
PermissionInterceptor-->>Client : 如果权限不足，返回403错误
PermissionInterceptor->>PermissionInterceptor : 检查类级@RequireRole
PermissionInterceptor->>PermissionInterceptor : 验证用户角色
PermissionInterceptor-->>Client : 如果角色不足，返回403错误
PermissionInterceptor-->>Client : 放行请求
```

**Diagram sources**
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L32-L84)
- [RequestContext.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/util/RequestContext.java#L25-L27)

**Section sources**
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L29-L134)

## 权限控制机制

### 注解定义与使用

系统提供了`@RequireRole`和`@RequirePermission`两个注解，用于在方法或类级别声明访问控制要求。这两个注解都使用`RUNTIME`保留策略，可以在运行时通过反射获取。

```mermaid
classDiagram
class RequireRole {
<<annotation>>
+String[] value()
}
class RequirePermission {
<<annotation>>
+String[] value()
}
class PermissionInterceptor {
+boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
+boolean hasPermission(TokenInfo tokenInfo, String[] requiredPermissions)
+boolean hasRole(TokenInfo tokenInfo, String[] requiredRoles)
}
PermissionInterceptor --> RequireRole : "检查"
PermissionInterceptor --> RequirePermission : "检查"
```

**Diagram sources**
- [RequireRole.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequireRole.java#L14-L24)
- [RequirePermission.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequirePermission.java#L14-L24)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L49-L63)

**Section sources**
- [RequireRole.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequireRole.java#L1-L24)
- [RequirePermission.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequirePermission.java#L1-L24)

### 权限检查逻辑

权限检查逻辑在`PermissionInterceptor`中实现，支持方法级别和类级别的注解检查。对于角色检查，用户需要具有注解中声明的任一角色；对于权限检查，用户需要具有注解中声明的所有权限。

```mermaid
flowchart TD
Start([开始]) --> GetUserInfo["获取当前用户信息"]
GetUserInfo --> UserAuthenticated{"用户已认证?"}
UserAuthenticated --> |否| ReturnForbidden1["返回403错误"]
UserAuthenticated --> |是| CheckMethodPermission["检查方法级@RequirePermission"]
CheckMethodPermission --> HasMethodPermission{"有方法级权限注解?"}
HasMethodPermission --> |否| CheckMethodRole["检查方法级@RequireRole"]
HasMethodPermission --> |是| ValidateMethodPermission["验证方法级权限"]
ValidateMethodPermission --> MethodPermissionValid{"权限足够?"}
MethodPermissionValid --> |否| ReturnForbidden2["返回403错误"]
MethodPermissionValid --> |是| CheckMethodRole["检查方法级@RequireRole"]
CheckMethodRole --> HasMethodRole{"有方法级角色注解?"}
HasMethodRole --> |否| CheckClassPermission["检查类级@RequirePermission"]
HasMethodRole --> |是| ValidateMethodRole["验证方法级角色"]
ValidateMethodRole --> MethodRoleValid{"角色足够?"}
MethodRoleValid --> |否| ReturnForbidden3["返回403错误"]
MethodRoleValid --> |是| CheckClassPermission["检查类级@RequirePermission"]
CheckClassPermission --> HasClassPermission{"有类级权限注解?"}
HasClassPermission --> |否| CheckClassRole["检查类级@RequireRole"]
HasClassPermission --> |是| ValidateClassPermission["验证类级权限"]
ValidateClassPermission --> ClassPermissionValid{"权限足够?"}
ClassPermissionValid --> |否| ReturnForbidden4["返回403错误"]
ClassPermissionValid --> |是| CheckClassRole["检查类级@RequireRole"]
CheckClassRole --> HasClassRole{"有类级角色注解?"}
HasClassRole --> |否| AllowRequest["放行请求"]
HasClassRole --> |是| ValidateClassRole["验证类级角色"]
ValidateClassRole --> ClassRoleValid{"角色足够?"}
ClassRoleValid --> |否| ReturnForbidden5["返回403错误"]
ClassRoleValid --> |是| AllowRequest["放行请求"]
ReturnForbidden1 --> End([结束])
ReturnForbidden2 --> End
ReturnForbidden3 --> End
ReturnForbidden4 --> End
ReturnForbidden5 --> End
AllowRequest --> End
```

**Diagram sources**
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L32-L84)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L90-L102)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L107-L119)

**Section sources**
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L29-L134)

## API接口与使用示例

### 认证API接口

系统提供了完整的RESTful API接口用于认证和授权操作，所有接口都位于`/api/auth`路径下。

```mermaid
erDiagram
AUTH_API ||--o{ LOGIN : "POST"
AUTH_API ||--o{ REGISTER : "POST"
AUTH_API ||--o{ CAPTCHA : "GET"
AUTH_API ||--o{ REFRESH : "POST"
AUTH_API ||--o{ LOGOUT : "POST"
LOGIN {
string username PK
string password PK
string captchaId
string captcha
}
REGISTER {
string username PK
string password PK
string email
string phoneNumber
string institution
}
CAPTCHA {
string captchaId PK
byte[] imageBytes
}
REFRESH {
string refreshToken PK
}
LOGOUT {
string Authorization
}
```

**Diagram sources**
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java#L39-L97)

**Section sources**
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java#L26-L118)

### API使用示例

#### 用户登录
```http
POST /api/auth/login HTTP/1.1
Content-Type: application/json

{
    "username": "user1",
    "password": "password123",
    "captchaId": "captcha_12345",
    "captcha": "ABCD"
}
```

#### 用户注册
```http
POST /api/auth/register HTTP/1.1
Content-Type: application/json

{
    "username": "newuser",
    "password": "NewPass123!",
    "email": "newuser@example.com",
    "phoneNumber": "13800138000",
    "institution": "交通研究所"
}
```

#### 刷新令牌
```http
POST /api/auth/refresh HTTP/1.1
Content-Type: application/json

{
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 用户登出
```http
POST /api/auth/logout HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Section sources**
- [AuthController.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/controller/AuthController.java#L39-L97)

## 安全最佳实践与问题

### 生产环境安全建议

根据代码分析，以下是生产环境部署时的安全最佳实践：

1. **更换JWT密钥**：必须将`AuthPluginProperties`中的`jwt.secret`从默认值更改为高强度的随机字符串
2. **调整令牌过期时间**：根据安全要求调整`jwt.expire`和`jwt.refreshExpire`的值
3. **启用密码强度要求**：在生产环境中应启用密码强度验证，设置合理的密码策略
4. **启用验证码**：在生产环境中建议启用验证码以防止暴力破解攻击

### 已知问题与改进建议

根据`plugin-auth-Issue.md`文件中的记录，系统存在一些待修复的问题：

1. **密码传递问题**：`AuthServiceImpl.register()`方法中，`UserDTO`不包含密码字段，需要通过`UserServiceExt.createUserWithPassword()`方法解决
2. **令牌失效机制不完整**：`logout()`方法只将accessToken标记为失效，但没有清理对应的refreshToken，建议维护accessToken和refreshToken的映射关系
3. **权限列表硬编码**：`createTokenInfo()`方法中权限列表是硬编码的，建议从数据库或配置中获取

**Section sources**
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L35-L36)
- [plugin-auth-Issue.md](file://plugins/plugin-auth/plugin-auth-Issue.md#L37-L94)

## 总结

本系统实现了基于JWT的完整认证与授权机制，具有以下特点：

1. **模块化设计**：认证功能以插件形式实现，与其他业务模块解耦
2. **安全性**：使用JWT进行无状态认证，支持刷新令牌机制，提供验证码保护
3. **灵活性**：通过配置文件可以灵活调整认证参数，如令牌过期时间、密码策略等
4. **细粒度权限控制**：基于角色和权限的双重控制，支持方法级别的访问控制
5. **易用性**：提供完整的RESTful API接口，便于前端集成

系统整体架构清晰，代码结构合理，但在生产环境部署时需要注意更换默认密钥、完善令牌失效机制等安全问题。通过遵循文档中的安全最佳实践，可以确保系统在生产环境中的安全性。

**Section sources**
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L1-L263)
- [JwtTokenService.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/JwtTokenService.java#L1-L118)
- [AuthPluginProperties.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginProperties.java#L1-L105)