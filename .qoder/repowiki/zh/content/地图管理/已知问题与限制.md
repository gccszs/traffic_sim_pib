# 已知问题与限制

<cite>
**本文档引用的文件**   
- [MapServiceImpl.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapServiceImpl.java)
- [MapPythonGrpcClient.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/client/MapPythonGrpcClient.java)
- [MapPermissionService.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapPermissionService.java)
- [MapController.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/controller/MapController.java)
- [MapPluginProperties.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/config/MapPluginProperties.java)
- [TokenInfo.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/service/TokenInfo.java)
</cite>

## 目录
1. [引言](#引言)
2. [地图文件自动转换功能未实现](#地图文件自动转换功能未实现)
3. [地图预览功能不可用](#地图预览功能不可用)
4. [权限检查中管理员标识获取逻辑缺失](#权限检查中管理员标识获取逻辑缺失)
5. [临时解决方案与未来修复路线图](#临时解决方案与未来修复路线图)

## 引言
本文档旨在详细说明地图管理模块中存在的已知问题与限制。通过对核心实现文件的分析，识别出影响系统功能完整性的关键缺陷，包括地图文件自动转换功能缺失、地图预览功能不可用以及权限验证机制不准确等问题。这些问题主要集中在`MapServiceImpl.java`和`MapPythonGrpcClient.java`等关键类中，通过`TODO`注释明确标记了待实现的功能点。本文件为开发团队提供了问题的详细说明及建议的修复路径。

## 地图文件自动转换功能未实现

在当前系统中，地图文件的上传流程仅完成了文件存储部分，而核心的格式转换功能尚未实现。当用户上传地图文件（如OSM、TXT等格式）时，系统会将其保存到指定路径，但不会调用Python服务进行实际的地图格式转换。

该问题的根本原因在于`MapServiceImpl.java`中的`uploadAndConvertMap`方法内存在未完成的gRPC调用逻辑。具体表现为：

- 在`uploadAndConvertMap`方法的第93行，存在明确的`// TODO: 实现gRPC调用Python服务`注释，表明此处需要集成gRPC客户端来与Python后端服务通信。
- 实际的gRPC客户端`MapPythonGrpcClient.java`目前仅为占位实现。其`uploadAndConvertFile`方法（第27行）同样包含`// TODO: 实现gRPC调用`注释，并在第33-40行返回了一个硬编码的失败响应，表明该功能尚未开发。

因此，当前系统仅支持地图文件的上传和存储，而不进行任何实际的格式转换。上传的文件无法被仿真引擎直接使用，因为缺少必要的XML格式输出。

**Section sources**
- [MapServiceImpl.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapServiceImpl.java#L80-L119)
- [MapPythonGrpcClient.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/client/MapPythonGrpcClient.java#L26-L41)

## 地图预览功能不可用

地图预览功能目前完全不可用，因为其核心实现方法`previewMapInfo`为空。该方法位于`MapServiceImpl.java`中，是`MapService`接口的一部分，用于在用户上传或查看地图前提供地图内容的预览。

具体问题如下：
- `previewMapInfo`方法（第275-280行）的实现体中，仅创建了一个空的`MapInfoDTO`对象并直接返回。
- 方法内部存在`// TODO: 实现预览逻辑`的注释（第278行），明确指出预览功能的解析和数据提取逻辑尚未开发。
- 该方法的调用链路（通过`MapController`的`/previewMapInfo`端点）虽然存在，但由于后端逻辑为空，任何请求都将返回一个空的JSON响应，无法提供任何有效的地图信息。

这导致用户在上传地图后无法预览其内容，降低了用户体验和系统的可用性。

**Section sources**
- [MapServiceImpl.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapServiceImpl.java#L274-L280)
- [MapController.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/controller/MapController.java#L96-L106)

## 权限检查中管理员标识获取逻辑缺失

系统的权限检查机制存在严重缺陷，可能导致权限验证不准确。在多个需要管理员权限的操作中（如获取地图、修改地图、删除地图），`isAdmin`标志被硬编码为`false`，而不是从用户的认证信息中动态获取。

具体问题分析：
- 在`MapServiceImpl.java`的`getMapById`、`updateMap`、`deleteMap`和`getMapInfoFromMongoDB`等方法中，`isAdmin`变量被初始化为`false`（例如第163、178、204、258行）。
- 每个初始化位置都附有`// TODO: 从TokenInfo获取管理员标识`的注释，明确指出了该逻辑的缺失。
- 权限判断最终依赖于`MapPermissionService`，该服务的逻辑（如`canAccess`方法）正确地将`isAdmin`作为参数进行判断。但由于上游传入的`isAdmin`始终为`false`，即使是管理员用户也无法获得相应的权限，导致管理员功能（如查看所有地图、强制删除地图）无法正常工作。

此问题使得系统的权限模型形同虚设，所有用户（包括管理员）都被视为普通用户进行权限校验。

**Section sources**
- [MapServiceImpl.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapServiceImpl.java#L163-L164)
- [MapServiceImpl.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapServiceImpl.java#L178-L179)
- [MapPermissionService.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapPermissionService.java#L19-L37)

## 临时解决方案与未来修复路线图

为了确保系统能够继续开发和测试，同时为未来的正式修复提供清晰的指导，以下是针对上述问题的临时解决方案和长期修复路线图。

### 临时解决方案
1.  **绕过gRPC调用**：在开发和测试阶段，可以手动将符合格式的XML地图文件放置在`map_convert_services`目录下，并通过数据库直接插入`map`表记录，以模拟已转换的地图。
2.  **模拟管理员权限**：在`MapServiceImpl.java`中，可以临时将`isAdmin`变量设置为`true`（例如，通过一个配置开关或基于特定用户ID的判断），以便测试管理员相关的功能。
3.  **简化预览逻辑**：可以实现一个基础的预览功能，例如仅返回上传文件的元数据（文件名、大小、类型），而不解析其内部结构，以提供最基本的反馈。

### 未来修复路线图
1.  **实现gRPC客户端**：
    - 根据`plugin-simulation`模块中的`python_service.proto`文件，为地图转换服务定义新的gRPC接口。
    - 使用`protoc`和gRPC插件生成Java客户端存根。
    - 在`MapPythonGrpcClient.java`中实现`uploadAndConvertFile`方法，使用生成的客户端调用Python服务。
    - 在`MapServiceImpl.java`中注入并调用`MapPythonGrpcClient`，将上传的文件数据发送给Python服务，并处理返回的转换后的XML数据。
2.  **完善预览功能**：
    - 在`MapServiceImpl.java`的`previewMapInfo`方法中，实现对上传文件（如OSM）的解析逻辑。
    - 可以利用`map_utils`目录下的`osmtrans.py`等Python脚本，通过调用它们来提取地图的关键信息（如节点、道路、区域）。
    - 将解析出的信息填充到`MapInfoDTO`对象中并返回。
3.  **修复权限检查逻辑**：
    - 修改`MapServiceImpl.java`，注入`TokenInfo`服务或从`RequestContext`中获取完整的`TokenInfo`对象。
    - 根据`TokenInfo`中的`role`或`permissions`字段，判断当前用户是否为管理员，并将结果赋值给`isAdmin`变量。
    - 移除所有`// TODO`注释和硬编码的`false`值，确保权限检查的准确性。

通过遵循此路线图，可以系统性地解决当前地图管理模块的所有已知限制，实现一个功能完整、安全可靠的系统。

**Section sources**
- [MapPythonGrpcClient.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/client/MapPythonGrpcClient.java)
- [MapServiceImpl.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapServiceImpl.java)
- [TokenInfo.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/service/TokenInfo.java)
- [python_service.proto](file://plugins/plugin-simulation/src/main/proto/python_service.proto)