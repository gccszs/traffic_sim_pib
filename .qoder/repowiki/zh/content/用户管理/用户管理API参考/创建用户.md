# 创建用户

<cite>
**本文档引用的文件**  
- [UserCreateRequest.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/dto/UserCreateRequest.java)
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java)
- [User.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/entity/User.java)
- [UserPluginConfig.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/config/UserPluginConfig.java)
- [application.yml](file://plugins/plugin-user/src/main/resources/application.yml)
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java)
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java)
- [ErrorCode.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/constant/ErrorCode.java)
- [ApiResponse.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/response/ApiResponse.java)
</cite>

## 目录
1. [API端点概述](#api端点概述)
2. [请求详细说明](#请求详细说明)
3. [UserCreateRequest字段定义](#usercreaterequest字段定义)
4. [响应格式](#响应格式)
5. [curl命令示例](#curl命令示例)
6. [认证与权限控制](#认证与权限控制)
7. [密码加密存储机制](#密码加密存储机制)
8. [错误处理](#错误处理)

## API端点概述

创建用户API端点用于在系统中创建新用户。该端点通过HTTP POST方法暴露，遵循RESTful设计原则。

**API基本信息**
- **HTTP方法**: POST
- **URL路径**: `/api/user`
- **请求内容类型**: `application/json`
- **响应内容类型**: `application/json`

该端点由`UserController`类中的`createUser`方法实现，位于`plugin-user`插件模块中。

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L63-L68)

## 请求详细说明

### 请求头
创建用户请求需要包含以下请求头：

| 请求头 | 值 | 说明 |
|--------|-----|------|
| `Content-Type` | `application/json` | 指定请求体为JSON格式 |
| `Authorization` | `Bearer <JWT令牌>` | 认证令牌（需要ADMIN角色权限） |

### 请求体结构
请求体必须是一个JSON对象，包含用户创建所需的所有信息。请求体结构基于`UserCreateRequest`数据传输对象。

```json
{
  "username": "string",
  "password": "string",
  "email": "string",
  "phoneNumber": "string",
  "institution": "string",
  "roleId": 0
}
```

**Section sources**
- [UserCreateRequest.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/dto/UserCreateRequest.java#L14-L32)

## UserCreateRequest字段定义

`UserCreateRequest` DTO定义了创建用户时所需的字段及其验证规则。

### username
- **类型**: 字符串
- **约束条件**: 
  - 不能为空
  - 长度必须在3-50个字符之间
  - 必须唯一（系统中不能存在相同用户名）
- **验证规则**: 使用`@NotBlank`和`@Size(min=3, max=50)`注解进行验证
- **数据库约束**: 在`user`表中设置为非空且唯一

### password
- **类型**: 字符串
- **约束条件**:
  - 不能为空
  - 长度必须在6-100个字符之间
  - 必须符合密码强度要求（根据系统配置）
- **验证规则**: 使用`@NotBlank`和`@Size(min=6, max=100)`注解进行验证
- **安全考虑**: 密码在存储前会使用BCrypt算法加密

### email
- **类型**: 字符串
- **约束条件**:
  - 必须是有效的邮箱格式
  - 如果提供，必须唯一（系统中不能存在相同邮箱）
  - 可选字段（可以为空）
- **验证规则**: 使用`@Email`注解进行格式验证
- **数据库约束**: 在`user`表中设置为可空，但如果存在则必须唯一

### phoneNumber
- **类型**: 字符串
- **约束条件**:
  - 可选字段（可以为空）
  - 长度限制为20个字符
- **验证规则**: 无特殊验证注解，仅进行基本长度限制
- **数据库约束**: 在`user`表中设置为可空，最大长度20

### institution
- **类型**: 字符串
- **约束条件**:
  - 可选字段（可以为空）
  - 长度限制为200个字符
- **验证规则**: 无特殊验证注解
- **数据库约束**: 在`user`表中设置为可空，最大长度200

### roleId
- **类型**: 整数
- **约束条件**:
  - 可选字段（可以为空）
  - 如果提供，引用的角色必须存在于系统中
  - 角色ID必须对应数据库中已存在的角色记录
- **验证规则**: 在服务层进行存在性验证
- **数据库约束**: 在`user`表中作为外键引用`role`表

**Section sources**
- [UserCreateRequest.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/dto/UserCreateRequest.java#L14-L32)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L193-L229)
- [User.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/entity/User.java#L22-L38)

## 响应格式

API响应遵循统一的`ApiResponse`格式，包含状态码、消息和数据。

### 成功响应
当用户创建成功时，返回200状态码和包含用户信息的响应体。

```json
{
  "res": "ERR_OK",
  "msg": "用户创建成功",
  "data": {
    "id": 1,
    "username": "newuser",
    "email": "newuser@example.com",
    "phoneNumber": "13800138000",
    "institution": "Example Institution",
    "roleId": 1,
    "roleName": "USER",
    "status": "NORMAL",
    "createTime": "2024-01-01T00:00:00",
    "updateTime": "2024-01-01T00:00:00"
  },
  "timestamp": 1704067200000
}
```

### 响应字段说明
| 字段 | 类型 | 说明 |
|------|------|------|
| `res` | 字符串 | 响应码，成功时为`ERR_OK` |
| `msg` | 字符串 | 响应消息，描述操作结果 |
| `data` | 对象 | 用户数据对象，包含创建的用户信息 |
| `timestamp` | 长整型 | 响应时间戳（毫秒） |

**Section sources**
- [ApiResponse.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/response/ApiResponse.java#L14-L85)
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L67)

## curl命令示例

### 成功创建用户的示例
```bash
curl -X POST "http://localhost:8080/api/user" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "username": "newuser",
    "password": "password123",
    "email": "newuser@example.com",
    "phoneNumber": "13800138000",
    "institution": "Example Institution",
    "roleId": 1
  }'
```

### 验证失败场景示例

**用户名为空**
```bash
curl -X POST "http://localhost:8080/api/user" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "username": "",
    "password": "password123",
    "email": "newuser@example.com"
  }'
```

**密码长度不足**
```bash
curl -X POST "http://localhost:8080/api/user" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "username": "newuser",
    "password": "123",
    "email": "newuser@example.com"
  }'
```

**邮箱格式错误**
```bash
curl -X POST "http://localhost:8080/api/user" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "username": "newuser",
    "password": "password123",
    "email": "invalid-email"
  }'
```

**用户名已存在**
```bash
curl -X POST "http://localhost:8080/api/user" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "username": "existinguser",
    "password": "password123",
    "email": "newuser@example.com"
  }'
```

## 认证与权限控制

### 认证机制
创建用户API需要有效的JWT令牌进行认证。认证由`AuthenticationInterceptor`拦截器处理。

- **认证流程**:
  1. 客户端在`Authorization`头中提供`Bearer`令牌
  2. `AuthenticationInterceptor`拦截请求
  3. 验证JWT令牌的有效性
  4. 解析令牌中的用户信息并存储在请求上下文中

### 权限控制要求
只有具有ADMIN角色的用户才能调用此接口。

- **权限验证**:
  - 由`PermissionInterceptor`拦截器处理
  - 检查调用者角色是否具有执行此操作的权限
  - 如果没有适当权限，返回403禁止访问错误

- **角色要求**:
  - 必须具有`ADMIN`角色
  - 普通用户（USER角色）无法创建新用户
  - 系统通过`@RequireRole("ADMIN")`注解或类似机制强制执行此规则

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthInterceptor as "认证拦截器"
participant PermInterceptor as "权限拦截器"
participant UserService as "用户服务"
Client->>AuthInterceptor : POST /api/user + JWT令牌
AuthInterceptor->>AuthInterceptor : 验证JWT令牌有效性
alt 令牌有效
AuthInterceptor->>PermInterceptor : 继续处理
PermInterceptor->>PermInterceptor : 检查ADMIN角色
alt 具有ADMIN角色
PermInterceptor->>UserService : 创建用户
UserService->>Client : 返回200及用户信息
else 缺少ADMIN角色
PermInterceptor->>Client : 返回403禁止访问
end
else 令牌无效
AuthInterceptor->>Client : 返回401未授权
end
```

**Diagram sources**
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java#L24-L48)
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java)

**Section sources**
- [AuthPluginAutoConfiguration.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/config/AuthPluginAutoConfiguration.java#L24-L48)
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java)

## 密码加密存储机制

### 加密算法
系统使用BCrypt算法对密码进行加密存储，这是一种安全的密码哈希函数。

- **配置位置**: `UserPluginConfig.java`中的`passwordEncoder()`方法
- **加密方式**: 在`application.yml`中配置为`BCrypt`

### 实现细节
```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

- **加密过程**:
  1. 用户提交明文密码
  2. 系统使用BCryptPasswordEncoder对密码进行哈希
  3. 将哈希后的密码存储在数据库中
  4. 原始明文密码不会被存储

- **验证过程**:
  1. 用户登录时提交明文密码
  2. 系统从数据库获取存储的哈希密码
  3. 使用BCrypt算法验证提交的密码与存储的哈希是否匹配

### 安全考虑
- **盐值自动生成**: BCrypt自动为每个密码生成唯一的盐值，防止彩虹表攻击
- **计算强度可调**: 可以调整BCrypt的工作因子来平衡安全性和性能
- **不可逆性**: 哈希函数是单向的，无法从哈希值反推出原始密码
- **防暴力破解**: BCrypt设计为计算密集型，减慢暴力破解尝试的速度

**Section sources**
- [UserPluginConfig.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/config/UserPluginConfig.java#L20-L23)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L214-L216)
- [application.yml](file://plugins/plugin-user/src/main/resources/application.yml#L6)

## 错误处理

### 错误码定义
系统使用统一的错误码来标识不同类型的错误。

| 错误码 | 含义 | HTTP状态码 |
|--------|------|-----------|
| `ERR_OK` | 操作成功 | 200 |
| `ERR_ARG` | 参数错误 | 400 |
| `ERR_EXIST` | 资源已存在 | 400 |
| `ERR_NOT_FOUND` | 资源不存在 | 404 |
| `ERR_PERMISSION` | 权限不足 | 403 |
| `ERR_AUTH` | 认证失败 | 401 |

### 常见错误场景

**用户名已存在**
```json
{
  "res": "ERR_EXIST",
  "msg": "用户名已存在",
  "data": null,
  "timestamp": 1704067200000
}
```

**邮箱已被使用**
```json
{
  "res": "ERR_EXIST",
  "msg": "邮箱已被使用",
  "data": null,
  "timestamp": 1704067200000
}
```

**参数验证失败**
```json
{
  "res": "ERR_ARG",
  "msg": "用户名不能为空",
  "data": null,
  "timestamp": 1704067200000
}
```

**权限不足**
```json
{
  "res": "ERR_PERMISSION",
  "msg": "权限不足，需要ADMIN角色",
  "data": null,
  "timestamp": 1704067200000
}
```

**认证失败**
```json
{
  "res": "ERR_AUTH",
  "msg": "无效的认证令牌",
  "data": null,
  "timestamp": 1704067200000
}
```

**Section sources**
- [ErrorCode.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/constant/ErrorCode.java#L8-L54)
- [ApiResponse.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/response/ApiResponse.java#L66-L75)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L194-L202)