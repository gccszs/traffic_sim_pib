# 查询用户

<cite>
**本文档引用的文件**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java)
- [UserRepository.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/repository/UserRepository.java)
- [UserDTO.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/dto/UserDTO.java)
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java)
- [application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [init.sql](file://infrastructure/init.sql)
</cite>

## 目录
1. [简介](#简介)
2. [API端点详情](#api端点详情)
3. [用户数据结构](#用户数据结构)
4. [使用示例](#使用示例)
5. [认证与权限控制](#认证与权限控制)
6. [性能优化与缓存策略](#性能优化与缓存策略)
7. [错误处理](#错误处理)

## 简介

本文档详细说明了交通仿真系统中的用户查询API。系统提供了两个主要的用户查询端点：通过用户ID查询和通过用户名查询。这些API端点允许系统管理员和授权用户获取用户详细信息，支持系统的用户管理功能。API设计遵循RESTful原则，使用统一的响应格式，并集成完整的认证和权限控制机制。

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L1-L35)

## API端点详情

### GET /api/user/{id}

根据用户ID查询用户信息。

**请求详情**
- **HTTP方法**: GET
- **URL路径**: /api/user/{id}
- **路径参数**:
  - `id`: 用户ID（Long类型）

**响应格式**
- **HTTP状态码**: 200 (OK)
- **响应体**: 统一API响应格式，包含UserDTO对象

**使用场景**
此端点主要用于需要精确用户信息的场景，如用户详情页面、用户管理后台等。由于ID是用户的唯一标识符，此查询方式最为直接和高效。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "UserController"
participant Service as "UserService"
participant Repository as "UserRepository"
Client->>Controller : GET /api/user/123
Controller->>Service : getUserById(123)
Service->>Repository : findById(123)
Repository-->>Service : User实体
Service->>Service : 转换为UserDTO
Service-->>Controller : UserDTO
Controller-->>Client : ApiResponse.success(UserDTO)
```

**Diagram sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L43-L48)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L44-L48)
- [UserRepository.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/repository/UserRepository.java#L18)

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L43-L48)

### GET /api/user/username/{username}

根据用户名查询用户信息。

**请求详情**
- **HTTP方法**: GET
- **URL路径**: /api/user/username/{username}
- **路径参数**:
  - `username`: 用户名（String类型）

**响应格式**
- **HTTP状态码**: 200 (OK)
- **响应体**: 统一API响应格式，包含UserDTO对象

**使用场景**
此端点适用于需要通过用户名查找用户的场景，如登录验证、用户搜索功能等。用户名在系统中是唯一的，因此可以准确地定位到特定用户。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "UserController"
participant Service as "UserService"
participant Repository as "UserRepository"
Client->>Controller : GET /api/user/username/admin
Controller->>Service : getUserByUsername("admin")
Service->>Repository : findByUsername("admin")
Repository-->>Service : User实体
Service->>Service : 转换为UserDTO
Service-->>Controller : UserDTO
Controller-->>Client : ApiResponse.success(UserDTO)
```

**Diagram sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L53-L58)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L51-L56)
- [UserRepository.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/repository/UserRepository.java#L23-L24)

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L53-L58)

## 用户数据结构

### UserDTO字段说明

UserDTO是用户信息的数据传输对象，包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 用户唯一标识ID |
| username | String | 用户名，在系统中唯一 |
| email | String | 电子邮箱地址 |
| phoneNumber | String | 电话号码 |
| institution | String | 所属机构 |
| roleId | Integer | 角色ID，关联角色表 |
| roleName | String | 角色名称，从角色表获取 |
| status | String | 用户状态：NORMAL（正常）、BANNED（已禁用）、BLOCKED（已锁定） |
| createTime | Date | 创建时间 |
| updateTime | Date | 更新时间 |

**Section sources**
- [UserDTO.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/dto/UserDTO.java#L1-L29)

## 使用示例

### curl命令示例

**通过用户ID查询**
```bash
curl -X GET "http://localhost:3822/api/user/1" \
  -H "Authorization: Bearer your-jwt-token" \
  -H "Content-Type: application/json"
```

**通过用户名查询**
```bash
curl -X GET "http://localhost:3822/api/user/username/admin" \
  -H "Authorization: Bearer your-jwt-token" \
  -H "Content-Type: application/json"
```

### 典型请求/响应示例

**请求**
```
GET /api/user/1 HTTP/1.1
Host: localhost:3822
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

**成功响应**
```json
{
  "res": "OK",
  "msg": "ok",
  "data": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "phoneNumber": "13800138000",
    "institution": "交通管理局",
    "roleId": 1,
    "roleName": "管理员",
    "status": "NORMAL",
    "createTime": "2024-01-01T10:00:00",
    "updateTime": "2024-01-01T10:00:00"
  },
  "timestamp": 1704067200000
}
```

**用户不存在的响应**
```json
{
  "res": "ERR_NOT_FOUND",
  "msg": "用户不存在",
  "data": null,
  "timestamp": 1704067200000
}
```

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L43-L58)
- [ApiResponse.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/response/ApiResponse.java#L1-L85)

## 认证与权限控制

### 认证要求

所有用户查询API都需要进行身份认证。系统使用JWT（JSON Web Token）进行认证，客户端必须在请求头中提供有效的JWT令牌。

**认证流程**:
1. 客户端在请求头中提供`Authorization: Bearer <token>` 
2. 认证拦截器验证JWT令牌的有效性
3. 如果令牌有效，继续处理请求；否则返回401未授权错误

```mermaid
flowchart TD
Start([开始]) --> ExtractToken["提取Authorization头中的JWT令牌"]
ExtractToken --> ValidateToken{"令牌有效?"}
ValidateToken --> |是| GetUser["获取用户信息并存入上下文"]
ValidateToken --> |否| Return401["返回401未授权"]
GetUser --> CheckPermission["检查权限"]
Return401 --> End([结束])
CheckPermission --> End
```

**Diagram sources**
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java#L45-L75)

### 权限控制策略

系统采用基于角色和权限的访问控制（RBAC）模型。

**可查询用户信息的角色**:
- **管理员 (ADMIN)**: 可以查询所有用户信息
- **普通用户 (USER)**: 只能查询自己的信息

**权限注解**:
- `@RequireRole("ADMIN")`: 标记需要管理员角色的方法
- `@RequirePermission("user:query")`: 标记需要特定权限的方法

```mermaid
classDiagram
class User {
+Long id
+String username
+String email
+String status
}
class Role {
+Long id
+String roleName
+String roleCode
}
class Permission {
+Long id
+String permissionName
+String permissionCode
}
class TokenInfo {
+Long userId
+String username
+String role
+String[] permissions
}
User "1" --> "1" Role : 关联
Role "1" --> "*" Permission : 包含
TokenInfo "1" --> "1" User : 表示
```

**Diagram sources**
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L32-L84)
- [RequireRole.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequireRole.java#L1-L24)
- [RequirePermission.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/annotation/RequirePermission.java#L1-L24)

**Section sources**
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java#L26-L126)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L27-L134)

## 性能优化与缓存策略

### 数据库查询优化

系统使用Spring Data JPA进行数据库操作，通过以下方式优化查询性能：

1. **索引优化**: 在用户表的关键字段上创建了索引
   - `username`字段的唯一索引
   - `role_id`字段的普通索引
   - `status`字段的普通索引

2. **查询方法优化**: 使用JPA Repository的查询方法，避免N+1查询问题

```sql
-- 用户表索引
CREATE UNIQUE INDEX uk_username ON user(username);
CREATE INDEX idx_role_id ON user(role_id);
CREATE INDEX idx_status ON user(status);
```

**Section sources**
- [init.sql](file://infrastructure/init.sql#L37-L39)
- [UserRepository.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/repository/UserRepository.java#L18-L51)

### 缓存策略

目前系统尚未实现缓存机制，但已预留了扩展点。未来可以考虑以下缓存策略：

1. **Redis缓存**: 将频繁访问的用户信息缓存到Redis中
2. **本地缓存**: 使用Caffeine或Ehcache进行本地缓存
3. **缓存失效策略**: 设置合理的缓存过期时间，或在用户信息更新时主动清除缓存

虽然当前版本没有实现缓存，但系统架构支持后续添加缓存功能，以提高高并发场景下的查询性能。

**Section sources**
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L44-L56)

## 错误处理

系统采用统一的异常处理机制，所有API响应都遵循统一的响应格式。

**常见错误码**:
- `ERR_NOT_FOUND`: 用户不存在
- `ERR_AUTH`: 认证失败
- `ERR_PERMISSION`: 权限不足

**全局异常处理器**:
系统通过`GlobalExceptionHandler`类处理所有未捕获的异常，确保返回格式统一的错误响应。

```mermaid
flowchart TD
Request["收到HTTP请求"] --> Authentication["认证拦截器"]
Authentication --> |认证失败| Return401["返回401未授权"]
Authentication --> |认证成功| Authorization["权限拦截器"]
Authorization --> |权限不足| Return403["返回403禁止访问"]
Authorization --> |权限足够| Business["业务逻辑处理"]
Business --> |处理成功| Return200["返回200成功"]
Business --> |处理失败| Exception["抛出异常"]
Exception --> GlobalHandler["全局异常处理器"]
GlobalHandler --> ReturnError["返回统一错误格式"]
```

**Diagram sources**
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java#L116-L123)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L124-L131)

**Section sources**
- [ApiResponse.java](file://traffic-sim-common/src/main/java/com/traffic/sim/common/response/ApiResponse.java#L1-L85)
- [AuthenticationInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/AuthenticationInterceptor.java#L116-L123)