# 删除用户

<cite>
**本文档引用的文件**  
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java)
- [User.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/entity/User.java)
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java)
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java)
- [MapQuotaService.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapQuotaService.java)
- [SimulationTask.java](file://plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/entity/SimulationTask.java)
</cite>

## 目录
1. [API端点说明](#api端点说明)
2. [权限控制机制](#权限控制机制)
3. [删除策略与级联处理](#删除策略与级联处理)
4. [审计日志与安全考虑](#审计日志与安全考虑)
5. [使用示例](#使用示例)

## API端点说明

DELETE `/api/user/{id}` 端点用于删除指定用户。该接口通过 `UserController` 类实现，具体方法为 `deleteUser`。

- **HTTP方法**: DELETE
- **URL路径**: `/api/user/{id}`
- **请求参数**:
  - `id` (路径参数): 要删除的用户ID，类型为 `Long`
- **响应格式**:
  - 成功响应: `200 OK`
  - 响应体: `{"code": 200, "message": "用户删除成功", "data": null}`
  - 错误响应: `404 Not Found` (用户不存在) 或 `403 Forbidden` (权限不足)

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L97-L102)

## 权限控制机制

删除用户操作受到严格的权限控制。系统使用基于角色和权限的访问控制（RBAC）模型，通过 `@RequirePermission` 和 `@RequireRole` 注解实现。

- **认证机制**: 使用JWT（JSON Web Token）进行用户认证
- **权限要求**: 执行删除操作的用户必须具有 `user:delete` 权限
- **角色要求**: 通常只有 `ADMIN` 角色的用户才拥有此权限
- **拦截器**: `PermissionInterceptor` 在请求处理前验证用户权限，若权限不足则返回403状态码

**Section sources**
- [PermissionInterceptor.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/interceptor/PermissionInterceptor.java#L41-L84)
- [AuthServiceImpl.java](file://plugins/plugin-auth/src/main/java/com/traffic/sim/plugin/auth/service/AuthServiceImpl.java#L217-L221)

## 删除策略与级联处理

系统采用硬删除策略，即直接从数据库中移除用户记录。删除操作是事务性的，确保数据一致性。

### 级联处理逻辑

当删除用户时，系统会自动处理与该用户相关的所有资源：

1. **地图资源**: 用户上传的所有地图将被删除，同时更新配额信息
2. **仿真任务**: 用户创建的所有仿真任务将被删除
3. **配额信息**: 用户的地图存储配额记录将被清理

```mermaid
flowchart TD
A[开始删除用户] --> B{用户存在?}
B --> |否| C[返回404错误]
B --> |是| D{有删除权限?}
D --> |否| E[返回403错误]
D --> |是| F[删除用户记录]
F --> G[删除用户的所有地图]
G --> H[删除用户的仿真任务]
H --> I[清理用户配额]
I --> J[提交事务]
J --> K[返回成功响应]
```

**Diagram sources**
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L146-L150)
- [MapQuotaService.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapQuotaService.java#L63-L68)

**Section sources**
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L143-L151)
- [MapQuotaService.java](file://plugins/plugin-map/src/main/java/com/traffic/sim/plugin/map/service/MapQuotaService.java#L60-L71)

## 审计日志与安全考虑

系统记录所有删除操作的审计日志，确保操作可追溯。

- **日志记录**: 每次删除操作都会在服务端日志中记录，包括操作时间、用户ID和执行者信息
- **安全考虑**:
  - 删除操作需要严格的权限验证
  - 使用HTTPS加密传输，防止敏感信息泄露
  - 操作前验证用户存在性，避免无效操作
  - 事务性操作确保数据一致性
- **软删除考虑**: 当前系统采用硬删除，但可通过添加 `status` 字段实现软删除功能

**Section sources**
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L150)
- [User.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/entity/User.java#L41)

## 使用示例

### curl命令示例

```bash
curl -X DELETE 'http://localhost:8080/api/user/123' \
  -H 'Authorization: Bearer your-jwt-token' \
  -H 'Content-Type: application/json'
```

### 典型请求/响应示例

**请求**:
```
DELETE /api/user/123 HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Host: localhost:8080
```

**成功响应**:
```json
{
  "code": 200,
  "message": "用户删除成功",
  "data": null
}
```

**错误响应（用户不存在）**:
```json
{
  "code": 404,
  "message": "用户不存在",
  "data": null
}
```

**错误响应（权限不足）**:
```json
{
  "code": 403,
  "message": "权限不足",
  "data": null
}
```

**Section sources**
- [UserController.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/controller/UserController.java#L97-L102)
- [UserServiceImpl.java](file://plugins/plugin-user/src/main/java/com/traffic/sim/plugin/user/service/UserServiceImpl.java#L146-L148)