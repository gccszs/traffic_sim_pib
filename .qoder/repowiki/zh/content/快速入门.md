# 快速入门

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [pom.xml](file://pom.xml)
- [infrastructure/README.md](file://infrastructure/README.md)
- [infrastructure/docker-compose.yml](file://infrastructure/docker-compose.yml)
- [infrastructure/start.sh](file://infrastructure/start.sh)
- [infrastructure/stop.sh](file://infrastructure/stop.sh)
- [infrastructure/init.sql](file://infrastructure/init.sql)
- [traffic-sim-server/pom.xml](file://traffic-sim-server/pom.xml)
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml)
- [traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java](file://traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java)
- [map_convert_services/Dockerfile](file://map_convert_services/Dockerfile)
- [map_convert_services/web_app.py](file://map_convert_services/web_app.py)
- [plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/GrpcClientConfig.java](file://plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/GrpcClientConfig.java)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [基础设施部署](#基础设施部署)
4. [主应用部署](#主应用部署)
5. [地图转换服务部署](#地图转换服务部署)
6. [端到端示例](#端到端示例)
7. [常见问题与验证](#常见问题与验证)

## 简介

本指南旨在为新手用户提供一份详细的入门教程，指导如何在本地环境中部署和运行traffic_sim_pib项目。内容涵盖从克隆仓库、安装必要依赖（JDK 17+、Maven、Docker）到配置Docker镜像加速的完整流程。指南将详细介绍如何使用docker-compose启动MySQL、MongoDB、Redis等基础设施服务，以及如何启动主应用（traffic-sim-server）和地图转换服务（map_convert_services）。此外，还将提供一个完整的端到端示例，包括用户登录、上传地图和创建仿真任务的步骤。最后，指南会指出常见问题（如gRPC服务未启动）的解决方案，并提供验证服务是否正常运行的方法。

## 环境准备

在开始部署之前，需要确保本地环境已安装并配置好以下软件：

- **JDK 17+**：项目基于Java 17开发，需确保已安装JDK 17或更高版本。可通过命令`java -version`验证安装。
- **Maven 3.6+**：用于项目构建和依赖管理。可通过命令`mvn -version`验证安装。
- **Docker Desktop 或 Docker Engine 20.10+**：用于容器化部署数据库和中间件服务。需确保Docker服务正在运行。
- **Docker Compose 2.0+**：用于管理多容器应用。可通过命令`docker-compose --version`验证安装。

**Section sources**
- [README.md](file://README.md#L90-L96)

## 基础设施部署

基础设施服务包括MySQL、MongoDB、Redis、Kafka等，均通过Docker Compose进行管理。部署步骤如下：

### 配置Docker镜像加速

为避免在拉取Docker镜像时因网络问题导致失败，建议配置国内镜像源。可通过以下两种方式之一进行配置：

1. **配置Docker Desktop**：打开Docker Desktop设置，进入Docker Engine，添加以下镜像源：
   ```json
   {
     "registry-mirrors": [
       "https://registry.cn-hangzhou.aliyuncs.com",
       "https://mirror.ccs.tencentyun.com",
       "https://dockerproxy.com",
       "https://hub-mirror.c.163.com"
     ]
   }
   ```
2. **修改docker-compose.yml**：在`infrastructure/docker-compose.yml`文件中，使用国内镜像源（如`m.daocloud.io`）来拉取镜像。

**Section sources**
- [infrastructure/README.md](file://infrastructure/README.md#L33-L69)

### 启动基础设施服务

进入`infrastructure`目录，使用提供的脚本或直接使用docker-compose命令启动所有服务。

```bash
cd infrastructure
# 启动所有服务（后台运行）
docker-compose up -d
```

或使用提供的启动脚本：
```bash
# Linux/Mac
./start.sh

# Windows
start.bat
```

启动后，可通过`docker-compose ps`命令查看服务状态，确保所有服务（如mysql、mongodb、redis）均处于"Up"状态。

**Section sources**
- [infrastructure/README.md](file://infrastructure/README.md#L81-L95)
- [infrastructure/start.sh](file://infrastructure/start.sh#L24-L26)

### 停止基础设施服务

当需要停止服务时，可使用以下命令：
```bash
# 停止所有服务（保留数据）
docker-compose stop

# 或使用停止脚本
./stop.sh
```

**Section sources**
- [infrastructure/README.md](file://infrastructure/README.md#L97-L107)
- [infrastructure/stop.sh](file://infrastructure/stop.sh#L10-L11)

## 主应用部署

主应用`traffic-sim-server`是基于Spring Boot 3.x的单体应用，负责处理所有业务逻辑。

### 编译项目

在项目根目录下执行Maven命令编译整个项目：
```bash
mvn clean install
```

此命令将编译所有模块，包括`traffic-sim-common`、`traffic-sim-server`和所有插件模块。

**Section sources**
- [README.md](file://README.md#L113-L117)

### 配置数据库连接

主应用的数据库配置位于`traffic-sim-server/src/main/resources/application.yml`文件中。默认配置已指向本地的MySQL和MongoDB服务，通常无需修改：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/traffic_sim
    username: root
    password: root
  data:
    mongodb:
      uri: mongodb://root:root@localhost:27017/traffic_sim?authSource=admin
```

**Section sources**
- [traffic-sim-server/src/main/resources/application.yml](file://traffic-sim-server/src/main/resources/application.yml#L5-L39)

### 启动主应用

编译完成后，进入`traffic-sim-server`目录并启动应用：
```bash
cd traffic-sim-server
mvn spring-boot:run
```

应用默认在8080端口启动，可通过访问`http://localhost:8080/api/swagger-ui.html`查看API文档。

**Section sources**
- [README.md](file://README.md#L119-L124)
- [traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java](file://traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java#L24-L26)

## 地图转换服务部署

地图转换服务`map_convert_services`是一个基于Python的FastAPI应用，负责处理地图文件的上传和转换。

### 构建并启动服务

该服务通过Docker进行部署。首先，构建Docker镜像：
```bash
cd map_convert_services
docker build -t map-convert-service .
```

然后，启动容器：
```bash
docker run -d -p 8000:8000 --name map-convert-container map-convert-service
```

服务将在8000端口监听，提供文件上传和转换的API。

**Section sources**
- [map_convert_services/Dockerfile](file://map_convert_services/Dockerfile#L1-L66)
- [map_convert_services/web_app.py](file://map_convert_services/web_app.py#L267-L269)

## 端到端示例

以下是一个完整的用户操作流程示例：

1. **用户登录**：使用`plugin-auth`插件提供的登录接口，通过用户名和密码获取JWT令牌。
2. **上传地图**：调用`map_convert_services`的`/fileupload`接口上传地图文件，服务将文件转换为系统所需的格式并返回结果。
3. **创建仿真任务**：使用`plugin-simulation`插件的`/init_simeng`接口，传入地图信息和仿真配置，创建一个新的仿真任务。

此流程展示了系统各组件之间的协同工作，从用户认证到地图处理再到仿真任务创建的完整链条。

**Section sources**
- [map_convert_services/web_app.py](file://map_convert_services/web_app.py#L52-L80)
- [map_convert_services/web_app.py](file://map_convert_services/web_app.py#L90-L188)

## 常见问题与验证

### gRPC服务未启动

主应用通过gRPC与Python服务通信。如果gRPC服务未启动，应用启动时会记录警告，但不会失败。可通过以下方式解决：
- 确保`map_convert_services`已正确启动。
- 在`application.yml`中，`grpc.client.python-service.address`应指向正确的gRPC服务地址。

**Section sources**
- [traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java](file://traffic-sim-server/src/main/java/com/traffic/sim/TrafficSimApplication.java#L33-L38)
- [plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/GrpcClientConfig.java](file://plugins/plugin-simulation/src/main/java/com/traffic/sim/plugin/simulation/config/GrpcClientConfig.java#L19-L20)

### 验证服务状态

- **检查Docker服务**：使用`docker-compose ps`确保所有容器正常运行。
- **检查应用日志**：查看`traffic-sim-server`的控制台输出，确认无错误信息。
- **访问API文档**：通过`http://localhost:8080/api/swagger-ui.html`访问Swagger UI，验证API是否可用。

**Section sources**
- [infrastructure/README.md](file://infrastructure/README.md#L299-L311)