# 地图名称显示修复说明

## 问题描述

之前的实现中，前端获取仿真任务列表时，`mapName` 字段返回的是引擎内部使用的随机 UUID（如 `a1b2c3d4e5f6...`），而不是用户上传地图时定义的名称（如 `北京市中心区域`）。

## 问题原因

1. **引擎内部使用随机 UUID**：为了避免文件名冲突，引擎为每个地图生成一个随机 UUID 作为内部文件名
2. **数据库只存储了 UUID**：`simulation_task` 表的 `map_xml_name` 字段存储的是这个随机 UUID
3. **前端显示了 UUID**：前端从 `mapXmlName` 字段获取地图名称，显示的是 UUID 而不是用户定义的名称

## 解决方案

### 1. 数据库结构调整

在 `simulation_task` 表中添加两个新字段：

```sql
-- map_id: 用户地图的ID（关联 map 表）
ALTER TABLE simulation_task 
ADD COLUMN map_id VARCHAR(64) COMMENT '用户地图ID' AFTER map_xml_name;

-- map_name: 用户定义的地图名称（用于前端显示）
ALTER TABLE simulation_task 
ADD COLUMN map_name VARCHAR(255) COMMENT '用户定义的地图名称（用于前端显示）' AFTER map_id;
```

### 2. 字段说明

| 字段名 | 用途 | 示例值 | 说明 |
|--------|------|--------|------|
| `map_xml_name` | 引擎内部使用 | `a1b2c3d4e5f6...` | 随机生成的 UUID，避免文件名冲突 |
| `map_id` | 关联用户地图 | `1`, `2`, `3` | 用户地图表的主键 |
| `map_name` | 前端显示 | `北京市中心区域` | 用户上传地图时定义的名称 |

### 3. 代码修改

#### 3.1 实体类修改

**SimulationTask.java**:
```java
@Column(name = "map_xml_name", length = 255)
private String mapXmlName;  // 引擎内部使用的随机UUID

@Column(name = "map_id", length = 64)
private String mapId;  // 用户地图的ID

@Column(name = "map_name", length = 255)
private String mapName;  // 用户地图的名称（用于前端显示）
```

#### 3.2 DTO 修改

**SimulationTaskDTO.java**:
```java
/** 地图ID */
private String mapId;

/** 地图名称（用户定义的名称，用于前端显示） */
private String mapName;

/** 地图XML文件名（引擎内部使用的随机UUID） */
private String mapXmlName;
```

#### 3.3 Service 修改

**SimulationServiceImpl.java**:

在 `startSimulation` 方法中：
1. 从 `mapId` 查询地图信息
2. 获取用户定义的地图名称
3. 保存到数据库

```java
// 查询地图信息，获取用户定义的地图名称
MapDTO mapDTO = mapService.getMapById(mapId, parseUserId(userId));
if (mapDTO != null) {
    userMapName = mapDTO.getName();  // 获取用户定义的地图名称
}

// 保存到数据库
task.setMapId(request.getSimInfo().getMapId());
task.setMapName(userMapName);  // 用户定义的地图名称
task.setMapXmlName(xmlMapName);  // 引擎内部的随机UUID
```

在 `convertToSimpleDTO` 方法中：
```java
dto.setMapName(task.getMapName());  // 返回用户定义的地图名称
```

## 数据流程

```
用户上传地图
    ↓
map 表: id=1, name="北京市中心区域"
    ↓
创建仿真任务
    ↓
生成随机 UUID: "a1b2c3d4e5f6..."
    ↓
查询 map 表获取用户名称
    ↓
simulation_task 表:
  - map_id = "1"
  - map_name = "北京市中心区域"
  - map_xml_name = "a1b2c3d4e5f6..."
    ↓
前端获取任务列表
    ↓
显示: "北京市中心区域" ✅
```

## 前端 API 响应变化

### 之前（错误）

```json
{
  "taskId": "b2e2583144c04df1a5bdb9cf356c607b",
  "name": "测试仿真",
  "mapXmlName": "a1b2c3d4e5f6...",  // ❌ 显示的是 UUID
  "createTime": "2026-01-22T10:00:00"
}
```

### 现在（正确）

```json
{
  "taskId": "b2e2583144c04df1a5bdb9cf356c607b",
  "name": "测试仿真",
  "mapName": "北京市中心区域",  // ✅ 显示用户定义的名称
  "createTime": "2026-01-22T10:00:00"
}
```

## 部署步骤

### 方式1: 全新部署（推荐）

如果您准备重新部署数据库，直接使用更新后的 `init.sql`：

```bash
# 删除旧数据库（注意：会丢失所有数据！）
mysql -u root -p -e "DROP DATABASE IF EXISTS traffic_sim;"

# 执行初始化脚本（已包含 map_id 和 map_name 字段）
mysql -u root -p < infrastructure/init.sql
```

### 方式2: 现有数据库升级

如果您的数据库已有数据，需要手动添加字段：

```sql
-- 添加 map_id 字段
ALTER TABLE simulation_task 
ADD COLUMN map_id VARCHAR(64) COMMENT '用户地图ID（关联map表）' AFTER map_xml_name;

-- 添加 map_name 字段
ALTER TABLE simulation_task 
ADD COLUMN map_name VARCHAR(255) COMMENT '用户定义的地图名称（用于前端显示）' AFTER map_id;

-- 添加索引
CREATE INDEX idx_map_id ON simulation_task(map_id);
```

### 重启服务

```bash
./启动Java后端.bat
```

### 验证

- 创建新的仿真任务
- 调用 `/api/simulation/list` 接口
- 检查返回的 `mapName` 字段是否显示用户定义的名称

## 注意事项

1. **历史数据**：已存在的仿真任务记录的 `map_id` 和 `map_name` 字段为 NULL，需要手动迁移或重新创建
2. **兼容性**：`mapXmlName` 字段仍然保留，用于引擎内部使用
3. **性能**：为 `map_id` 添加了索引，提高查询性能

## 历史数据迁移（可选）

如果需要为历史数据填充 `map_id` 和 `map_name`，可以执行以下脚本：

```sql
-- 从 sim_config JSON 中提取 mapId，然后关联 map 表获取 map_name
UPDATE simulation_task st
LEFT JOIN map m ON m.id = JSON_UNQUOTE(JSON_EXTRACT(st.sim_config, '$.simInfo.mapId'))
SET 
    st.map_id = m.id,
    st.map_name = m.name
WHERE st.map_id IS NULL 
  AND st.sim_config IS NOT NULL
  AND JSON_EXTRACT(st.sim_config, '$.simInfo.mapId') IS NOT NULL;
```

**注意**：执行前请先备份数据库！

## 测试用例

### 测试1: 创建仿真任务

**请求**:
```bash
curl -X POST "http://localhost:3822/api/simulation/start?taskId=xxx" \
  -H "Content-Type: application/json" \
  -H "Cookie: id=1" \
  -d '{
    "simInfo": {
      "name": "测试仿真",
      "mapId": "1",
      "fixedOd": {}
    }
  }'
```

**预期结果**:
- 数据库 `simulation_task` 表中：
  - `map_id` = "1"
  - `map_name` = "北京市中心区域"（从 map 表查询）
  - `map_xml_name` = "a1b2c3d4e5f6..."（随机生成）

### 测试2: 获取任务列表

**请求**:
```bash
curl "http://localhost:3822/api/simulation/list?page=1&size=10" \
  -H "Cookie: id=1"
```

**预期响应**:
```json
{
  "res": "ERR_OK",
  "data": {
    "items": [
      {
        "taskId": "b2e2583144c04df1a5bdb9cf356c607b",
        "name": "测试仿真",
        "mapName": "北京市中心区域",
        "createTime": "2026-01-22T10:00:00"
      }
    ]
  }
}
```

## 总结

通过添加 `map_id` 和 `map_name` 字段，我们实现了：

✅ **前端显示用户定义的地图名称**，而不是引擎内部的 UUID
✅ **保持引擎内部使用 UUID**，避免文件名冲突
✅ **数据关联清晰**，可以追溯到原始地图
✅ **向后兼容**，不影响现有功能
